---
title: "Redis ã‚’ä½¿ã£ãŸ PV ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹"
emoji: ğŸ›¢ï¸
category: Tech
tags: [Tips]
status: published
publishedAt: 2024-07-28
updatedAt: 2024-08-05
---

v1.7.0 ã§ PV ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã€‚

https://kkhys.me/posts/p1v9jvx

ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã‹ã‚‰ 3 ãƒ¶æœˆã»ã©çµŒéã—ãŸãŒã€ä»¥ä¸‹ã®å•é¡ŒãŒæ°—ã«ãªã‚‹ã‚ˆã†ã«ãªã£ã¦ããŸã€‚

1. åˆæœŸè¡¨ç¤ºãŒé…ã„
2. 1 äººã®ãƒ¦ãƒ¼ã‚¶ãŒçŸ­æ™‚é–“ã« PV ã‚’å¢—ã‚„ã›ã‚‹ï¼ˆé‡è¤‡è¨ˆæ¸¬ï¼‰

ä¸Šè¨˜ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã« [Upstash](https://upstash.com) ã® Redis ã‚’ä½¿ã£ãŸå®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã«ã—ãŸã€‚

## ãªãœ Redis ã‚’ä½¿ã†ã®ã‹

ã¾ãš 1 ã¤ç›®ã®å•é¡Œã¯ DB ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«èµ·å› ã—ã¦ã„ã‚‹ã€‚
åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¬ã‚¹ DB ã‚µãƒ¼ãƒ“ã‚¹ [Neon](https://neon.tech) ã®æ—¥æœ¬ã‹ã‚‰æœ€ã‚‚è¿‘ã„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ã§ã‚ã‚‹ã€‚
ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ã‹ã‚‰æ—¥æœ¬ã¾ã§ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¯ 50ms ~ 100ms ã»ã©ãªã®ã§ã©ã†ã—ã¦ã‚‚åˆæœŸè¡¨ç¤ºã¯ãã‚Œä»¥ä¸Šã‹ã‹ã£ã¦ã—ã¾ã†ã€‚

Upstash ã¯ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«æ—¥æœ¬ï¼ˆAWS ã® ap-northeast-1ï¼‰ã‚’é¸æŠã§ãã‚‹ã®ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’ä½ãæŠ‘ãˆã‚‰ã‚Œã‚‹ã€‚
ã¾ãŸã€Redis ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚ã‚‹ãŸã‚ã€ãƒ‡ã‚£ã‚¹ã‚¯ I/O ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒãªãé«˜é€Ÿãª R/W ã‚’è¡Œãˆã‚‹ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚‹ã€‚

2 ã¤ç›®ã®å•é¡Œã¯ RDBMS ã§ã‚‚å¯¾å¿œå¯èƒ½ã ãŒã€å®šæœŸçš„ã«é‡è¤‡æ’é™¤ã®ãŸã‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã€‚
ã§ãªã„ã¨ã€DB ã®ã‚µã‚¤ã‚ºãŒã©ã‚“ã©ã‚“è†¨ã‚Œä¸ŠãŒã£ã¦ã—ã¾ã†ã€‚
Redis ã§ã‚ã‚Œã° Key-Value Pair ã®æœ‰åŠ¹æœŸé™ã‚’è¨­å®šå¯èƒ½ã§ã€ãã®æœŸé™ã‚’çµŒéã™ã‚‹ã¨è‡ªå‹•çš„ã«æ®ç™ºã™ã‚‹ã®ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åœ§è¿«ã™ã‚‹ã“ã¨ã‚‚ãªã„ã€‚

ä»¥ä¸Šã®ã“ã¨ã‹ã‚‰ PV ã‚«ã‚¦ãƒ³ãƒˆã®è¨ˆæ¸¬ã« Redis ã‚’ä½¿ã†ã®ã¯æœ‰åŠ¹ã¨åˆ¤æ–­ã—ãŸã€‚

## å®Ÿè£…æ–¹æ³•

### Upstash ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ Upstash ã®ç®¡ç†ç”»é¢ã‹ã‚‰ API ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã™ã‚‹ã€‚

```text title=".env"
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=
```

æ¬¡ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
pnpm add @upstash/redis
```

æœ€å¾Œã« Redis ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚Œã°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã€‚
`fromEnv` ã‚’ä½¿ãˆã°ç‰¹ã«ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿å–ã‚‹å‡¦ç†ã‚’æ›¸ã‹ãªãã¦è‰¯ã„ã®ã¯æ¥½ã ã€‚

```ts title="packages/api/src/utils/redis.ts"
import { Redis } from '@upstash/redis';

export const redis = Redis.fromEnv();
```

### API ã®ä½œæˆ

å½“ã‚µã‚¤ãƒˆã¯ API ä½œæˆã« tRPC ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚
tRPC ã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆã¯é©å®œèª­ã¿æ›¿ãˆã¦ã„ãŸã ããŸã„ã€‚

ã¾ãšã¯é‡è¤‡é˜²æ­¢ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰ã®ãŸã‚ã« IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ã—ãŸæœ‰åŠ¹æœŸé™ä»˜ãã® Key-Value Pair ã‚’ç™»éŒ²ã™ã‚‹ã€‚
ãã—ã¦ã€é‡è¤‡ãŒãªã„ã“ã¨ã‚’ç¢ºèªã§ããŸå ´åˆã®ã¿ `incr` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ PV ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ã€‚

```ts title="packages/api/src/router/page-view.ts" showLineNumbers
import type { TRPCRouterRecord } from '@trpc/server';
import { TRPCError } from '@trpc/server';
import { z } from 'zod';

import { env } from '../../env';
import { publicProcedure } from '../trpc';
import { getIpHash, redis } from '../utils';

export const pageViewRouter = {
  incrementViews: publicProcedure.input(z.object({ slug: z.string() })).mutation(async ({ ctx, input: { slug } }) => {
    if (!ctx.ip) {
      throw new TRPCError({ code: 'BAD_REQUEST' });
    }

    const ip = ctx.ip;
    const ipHash = await getIpHash(ip);

    const isNew = await redis.set(['deduplicate', ipHash, slug].join(':'), true, {
      nx: true,
      ex: 24 * 60 * 60,
    });

    if (!isNew) {
      return 'Deduplicated';
    }

    await redis.incr(['pageviews', env.NODE_ENV, slug].join(':'));

    return 'Incremented';
  }),
} satisfies TRPCRouterRecord;
```

ãŠå•ã„åˆã‚ã›æ©Ÿèƒ½ã®ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚’è¨­å®šã—ãŸã¨ãï¼ˆ[è¨˜äº‹](/posts/p143t9d)ï¼‰ã¨åŒæ§˜ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ã—ã¦ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ SHA-256 ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‹ã‚‰ Redis ã«ä¿å­˜ã™ã‚‹ã€‚
ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã® Key-Value Pair ã®æœ‰åŠ¹æœŸé™ã¯ 1 æ—¥ã«ã—ã¦ã„ã‚‹ã€‚
ã¤ã¾ã‚Šã€1IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ãŸã‚Š 1 ã¤ã®è¨˜äº‹ã«å¯¾ã—ã¦ 1 æ—¥ã« 1 å›ã®ã¿ã—ã‹ PV ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã§ããªã„ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚
ã¾ãŸã€`nx: true` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚­ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç™»éŒ²ã•ã‚Œãªã„ã€‚

ã™ã§ã« PV ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆæ¸ˆã¿ã®å ´åˆã¯ `'Deduplicated'` ã‚’è¿”ã—ã€ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã«æˆåŠŸã—ãŸå ´åˆã¯ `'Incremented'` ã‚’è¿”ã™ã€‚
tRPC ã®è‰¯ã„ã¨ã“ã‚ã¯ API ã®å‹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®šç¾©ã—ãªãã¦ã‚‚è‰¯ã„ã¨ã“ã‚ã ã€‚
ä¸Šè¨˜ã®å ´åˆã ã¨ `incrementViews` ã®è¿”ã‚Šå€¤ã®å‹ã¯ `'Deduplicated' | 'Incremented'` ã®ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã«ãªã‚‹ã€‚
ã“ã®å€¤ã¯æ¬¡ã®ç« ã§ä½¿ç”¨ã™ã‚‹ã€‚

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰å‘¼ã³å‡ºã™

PV ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ API ã‚’ä½œæˆã—ãŸã®ã§æ¬¡ã¯ PV ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ API ã‚’ä½œæˆã—ã¦ã„ãã€‚

```ts title="packages/api/src/router/page-view.ts" showLineNumbers
import type { TRPCRouterRecord } from '@trpc/server';
import { z } from 'zod';

import { env } from '../../env';
import { publicProcedure } from '../trpc';
import { redis } from '../utils';

export const pageViewRouter = {
  bySlug: publicProcedure
    .input(z.object({ slug: z.string() }))
    .query(async ({ input: { slug } }) => (await redis.get<number>(['pageviews', env.NODE_ENV, slug].join(':'))) ?? 0),
} satisfies TRPCRouterRecord;
```

ã‚»ãƒƒãƒˆã—ãŸã¨ãã®ã‚­ãƒ¼ã¨åŒã˜å€¤ã‚’ get ã™ã‚‹ã“ã¨ã§ PV ã‚’å–å¾—ã§ãã‚‹ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã« API ã‚’å‘¼ã³å‡ºã™ã€‚

```tsx title="apps/web/src/ui/post/view-counter/index.tsx" showLineNumbers
'use client';

import * as React from 'react';

import { Skeleton } from '@kkhys/ui';

import { api } from '#/lib/trpc/react';

export const ViewCounter = ({ slug }: { slug: string }) => {
  const utils = api.useUtils();

  const { mutate } = api.pageView.incrementViews.useMutation({
    onSuccess: async (status) => {
      if (status === 'Incremented') {
        await utils.pageView.bySlug.invalidate({ slug });
      }
    },
  });

  const { data } = api.pageView.bySlug.useQuery({ slug }, { staleTime: 60 * 1000 });

  React.useEffect(() => mutate({ slug }), [mutate, slug]);

  if (!data) return <ViewCounterSkeleton />;

  return <p className='font-sans text-sm text-muted-foreground'>{data.toLocaleString()} views</p>;
};

export const ViewCounterSkeleton = () => <Skeleton className='h-4 w-14' />;
```

ãƒã‚¤ãƒ³ãƒˆã¯ 2 ç‚¹ã‚ã‚‹ã€‚

ã¾ãš 1 ã¤ç›®ã¯ `useMutation` ã«æˆåŠŸã—ãŸå ´åˆï¼ˆ`onSuccess`ï¼‰ã€PV ã‚’æ›´æ–°ã—ãŸã¨ãã®ã¿ PV ã‚«ã‚¦ãƒ³ãƒˆã‚’ invalidate ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚
ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã®å¯¾è±¡ã¨ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã£ã¦ã‚‚ `onSuccess` ã®å‡¦ç†ãŒèµ°ã‚‹ãŸã‚ã€ä½•ã‚‚ã—ãªã‘ã‚Œã°ç„¡é§„ã« API ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã—ã¾ã†ã€‚
ãã‚Œã‚’é˜²ããŸã‚ã« `incrementViews` ã®è¿”ã‚Šå€¤ãŒ `Incremented` ã®å ´åˆã®ã¿ PV ã‚’æ›´æ–°ã™ã‚‹ã€‚

2 ã¤ç›®ã®ãƒã‚¤ãƒ³ãƒˆã¯ `useQuery` ã« `staleTime` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚
`staleTime` ã‚’è¨­å®šã—ãªã„ã¨ä½•åº¦ã‚‚ãƒªãƒ­ãƒ¼ãƒ‰ãŒè¡Œã‚ã‚ŒãŸå ´åˆã€ãã®å›æ•°åˆ†ã ã‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ã‚‰ã‚Œã¦ã—ã¾ã†ã€‚
Upstash ã¯å¾“é‡èª²é‡‘åˆ¶ãªã®ã§ä¸è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹[^1]ã€‚

[^1]: å¾“é‡èª²é‡‘åˆ¶ã¨ã¯ã„ã£ã¦ã‚‚ 1 æ—¥ 10,000 ã‚³ãƒãƒ³ãƒ‰ã¾ã§ã¯ç„¡æ–™ãªã®ã§ãã“ã¾ã§å¿ƒé…ã¯ã„ã‚‰ãªã„ã€‚
ä»®ã«ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã—ã¾ã£ã¦ã‚‚ 100,000 ã‚³ãƒãƒ³ãƒ‰ã‚ãŸã‚Š 0.2 ãƒ‰ãƒ«ã—ã‹æ”¯æ‰•ã„ã¯ç™ºç”Ÿã—ãªã„ï¼ˆ[ã‚½ãƒ¼ã‚¹](https://upstash.com/pricing)ï¼‰

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç§»è¡Œ

ä»Šã¾ã§ã¯ Neon ã® PostgreSQL ã« PV ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ãŸã€‚
Upstash ã® Redis ã«ç§»è¡Œã™ã‚‹ã«ã‚ãŸã‚Šã€PostgreSQL ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

Next.js ã« Ruby on Rails ã® Rake ã‚¿ã‚¹ã‚¯ã¿ãŸã„ãªæ©Ÿèƒ½ãŒã‚ã‚Œã°è‰¯ã„ã®ã ãŒã€æ®‹å¿µãªãŒã‚‰ç„¡ã„ã®ã§ API ã¨ã—ã¦å®šç¾©ã—ã¦ãã‚Œã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ã«ã—ãŸã€‚

```ts title="apps/web/src/ui/post/view-counter/index.tsx" showLineNumbers
import type { TRPCRouterRecord } from '@trpc/server';

import { publicProcedure } from '../trpc';
import { redis } from '../utils';

export const pageViewRouter = {
  import: publicProcedure.mutation(async ({ ctx }) => {
    const posts = await ctx.db.query.posts.findMany();
    posts.forEach((post) => void redis.setnx(['pageviews', 'production', post.slug].join(':'), post.views));
  }),
} satisfies TRPCRouterRecord;
```

æœ¬ç•ªç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¦å…¨ã¦ã® PV ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã€‚
ãã—ã¦ã€ãã‚Œã‚’ `forEach` ã§å›ã—ã¦ Redis ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã‘ã°å®Œäº†ã§ã‚ã‚‹ã€‚

å†ªç­‰æ€§ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã•ã›ãŸçŠ¶æ…‹ã§ï¼‰ãŒä¿ãŸã‚Œã‚‹ã‚ˆã†ã« `setnx` ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

å¿µã®ç‚ºã€ã¡ã‚ƒã‚“ã¨ç™»éŒ²ã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

ã¾ãšã¯ PostgreSQL å´ã®ãƒ‡ãƒ¼ã‚¿ã€‚

```sql
SELECT * FROM me_post ORDER BY slug;

+-------+-----+--------------------------+--------------------------+
|slug   |views|created_at                |updated_at                |
+-------+-----+--------------------------+--------------------------+
|p128uug|47   |2024-07-07 06:05:55.569318|2024-07-27 00:10:42.336000|
|p143t9d|8    |2024-07-27 07:44:32.707432|2024-07-27 08:21:13.394000|
|p15e6x7|105  |2024-05-19 12:40:25.512419|2024-07-27 00:10:11.409000|
|p164vu8|45   |2024-06-15 13:50:02.707545|2024-07-27 00:10:30.951000|
|p16ceda|38   |2024-04-07 04:04:19.174891|2024-07-27 08:01:10.329000|
|p16vfnq|59   |2024-04-07 04:04:31.853837|2024-07-27 03:29:25.920000|
|p18vcqd|43   |2024-04-07 04:04:33.979543|2024-07-27 03:28:57.797000|
|p1a95jw|118  |2024-05-15 14:00:43.888764|2024-07-22 04:34:23.322000|
|p1c8jpk|58   |2024-06-09 15:00:00.573275|2024-07-27 00:10:16.745000|
|p1e0lpm|37   |2024-04-07 04:04:58.937393|2024-07-27 03:29:37.042000|
|p1eemm6|64   |2024-04-07 04:04:37.635623|2024-07-27 06:07:07.161000|
|p1fw2ts|54   |2024-04-07 04:04:39.854620|2024-07-27 03:03:01.710000|
|p1g6z2d|26   |2024-04-07 04:04:25.338530|2024-07-07 03:52:33.672000|
|p1gvayx|48   |2024-06-20 14:18:37.999824|2024-07-27 00:10:39.531000|
|p1kc29z|32   |2024-07-14 10:23:41.045142|2024-07-26 12:58:25.458000|
|p1kqv7s|48   |2024-07-12 10:42:57.077724|2024-07-24 15:32:21.075000|
|p1n03k6|58   |2024-06-10 14:42:21.595135|2024-07-27 03:17:41.104000|
|p1r60de|157  |2024-04-07 04:03:58.912900|2024-07-27 08:16:17.285000|
|p1rklfz|31   |2024-04-07 04:04:47.664132|2024-07-24 14:27:28.827000|
|p1srf75|55   |2024-04-24 15:19:48.949461|2024-07-06 08:29:28.758000|
|p1t6el8|83   |2024-06-16 13:03:18.070267|2024-07-27 03:15:35.024000|
|p1ua4wh|40   |2024-05-14 15:17:23.575571|2024-07-25 10:40:58.893000|
|p1uchql|203  |2024-05-18 06:53:17.430213|2024-07-27 00:09:55.951000|
|p1v00e8|136  |2024-04-20 13:28:10.858223|2024-07-27 03:21:25.136000|
|p1v9jvx|72   |2024-04-23 15:11:34.886525|2024-07-27 09:19:21.205000|
|p1y4nft|52   |2024-04-07 04:04:42.417156|2024-07-22 04:33:42.593000|
|p1ys5j8|93   |2024-04-07 04:04:03.583977|2024-07-27 03:28:49.794000|
+-------+-----+--------------------------+--------------------------+
```

æ¬¡ã« Redis å´ã®ãƒ‡ãƒ¼ã‚¿ã€‚

```shell
redis-cli --tls -u redis://default:password@hostname:port "pageviews:production:*" | sort -n | while read key; do echo "$key: $(redis-cli --tls -u redis://default:password@hostname:port get $key)"; done

pageviews:production:p128uug: 47
pageviews:production:p143t9d: 8
pageviews:production:p15e6x7: 105
pageviews:production:p164vu8: 45
pageviews:production:p16ceda: 38
pageviews:production:p16vfnq: 59
pageviews:production:p18vcqd: 43
pageviews:production:p1a95jw: 118
pageviews:production:p1c8jpk: 58
pageviews:production:p1e0lpm: 37
pageviews:production:p1eemm6: 64
pageviews:production:p1fw2ts: 54
pageviews:production:p1g6z2d: 26
pageviews:production:p1gvayx: 48
pageviews:production:p1kc29z: 32
pageviews:production:p1kqv7s: 48
pageviews:production:p1n03k6: 58
pageviews:production:p1r60de: 157
pageviews:production:p1rklfz: 31
pageviews:production:p1srf75: 55
pageviews:production:p1t6el8: 83
pageviews:production:p1ua4wh: 40
pageviews:production:p1uchql: 203
pageviews:production:p1v00e8: 136
pageviews:production:p1v9jvx: 72
pageviews:production:p1y4nft: 52
pageviews:production:p1ys5j8: 93
```

PV ãŒä¸€è‡´ã—ã¦ã„ã‚‹ãŸã‚å•é¡Œãªã—ã€‚

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

Upstash ã¯æ¯æ—¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã¨ã£ã¦ãã‚Œã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãŸã‚æœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹ã€‚
ãƒªã‚¹ãƒˆã‚¢ã‚‚ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§è¡Œãˆã‚‹ãŸã‚ç°¡å˜ã€‚

![Upstash ã®ç®¡ç†ç”»é¢](/images/tech/2024-07-28/01.png "Upstash ã®ç®¡ç†ç”»é¢")

## ã•ã„ã”ã«

Upstash ã‚’ä½¿ã†ã¨é¢å€’ãª Redis ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚ä¸€ç¬ã§çµ‚ã‚ã£ãŸã€‚
ä¾¿åˆ©ã™ãã‚‹ã€‚

PV ã‚’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã•ã›ã‚‹ã“ã¨ã§å…¨ä½“çš„ã« PV ã¯æ¸›ã‚‹ã ã‚ã†ãŒå¤šããªã‚Œã°è‰¯ã„ã¨ã„ã†ã‚ã‘ã§ã‚‚ãªã„ã®ã§å•é¡Œãªã„ã€‚
æ­£ç¢ºãª PV æ•°ã‚’ç®—å‡ºã§ãã‚‹ã®ã§æ¥½ã—ã¿ã ã€‚
