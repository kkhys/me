---
title: Vultr + Arch Linux ã§ Mastodon ã‚’æ§‹ç¯‰ã™ã‚‹
description: å€‹äººç”¨ Mastodon ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ Arch Linux ã¨ Vultr ã§æ§‹ç¯‰ã™ã‚‹æŠ€è¡“ã‚¬ã‚¤ãƒ‰ã€‚
emoji: ğŸ¦£
category: Tech
tags: [Mastodon, Linux]
status: published
publishedAt: 2024-10-26
slug: b1ffkqq
---

ä»¥å‰ã‹ã‚‰è‡ªåˆ†å°‚ç”¨ã®ãƒã‚¤ã‚¯ãƒ­ãƒ–ãƒ­ã‚°ã‚’ç«‹ã¡ä¸Šã’ãŸã„ã¨æ€ã£ã¦ã„ãŸã€‚

X ã‚„ Facebookã€Instagram ã¨ã„ã£ãŸã¿ã‚“ãªãŒã‚ˆãä½¿ã£ã¦ã„ã‚‹ã€ã„ã‚ã‚†ã‚‹ä¸­å¤®é›†æ¨©å‹ SNS ã¯ã©ã†ã‚‚æŠ•ç¨¿ã—ç¶šã‘ã¦ã„ãã«ã¯æ°—ä¹—ã‚ŠãŒã—ãªã„ã€‚
ãã®åŸå› ã‚’è€ƒãˆã‚‹ã«ã€**å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒé‹å–¶ä¼šç¤¾ã«ç®¡ç†ã•ã‚Œã‚‹éƒ¨åˆ†ãŒæ°—ã«å…¥ã‚‰ãªã„**ã®ã ã¨æ€ã†ã€‚

è²·åã‚„ç ´ç¶»ã—ãŸã¨ãã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã†ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã®ã§ã€ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ã¨ã—ã¦ã¯å‘ã‹ãªã„ã€‚
è‡ªç”±ãªæ„è¦‹ã‚’æ›¸ãè¾¼ã‚ã°å ´åˆã«ã‚ˆã£ã¦ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‡çµã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ãã†ã„ã£ãŸå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¨ã—ã¦ã€åˆ†æ•£å‹ SNS ã® [Fediverse](https://ja.wikipedia.org/wiki/Fediverse) ã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚‹ã€‚

Fediverse ã¯ã€å…±é€šã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ç•°ãªã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚„ã‚µãƒ¼ãƒ“ã‚¹ãŒäº’ã„ã«é€šä¿¡ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã€‚
æœ€ã‚‚ä¸€èˆ¬çš„ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ Mastodon ã‚„ Misskey ãŒæ¡ç”¨ã—ã¦ã„ã‚‹ [ActivityPub](https://www.w3.org/TR/activitypub) ã§ã‚ã‚‹ã€‚

**ActivityPub ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç•°ãªã‚‹ã‚µãƒ¼ãƒã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«æ‰€å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶åŒå£«ãŒãƒ•ã‚©ãƒ­ãƒ¼ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€æŠ•ç¨¿ã®å…±æœ‰ãªã©ã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹ã€‚**

ã“ã‚ŒãŒã¾ã•ã«ç§ã®æ±‚ã‚ã¦ã„ãŸã‚‚ã®ã§ã€è‡ªç”±ã«ç™ºä¿¡ã—ã€ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ã¨ã—ã¦ã®å½¹å‰²ã‚’æœãŸã™ãŸã‚ã®æœ€é©ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ãªã‚Šå¾—ã‚‹ã¨è€ƒãˆãŸã€‚

Fediverse ã‚’ä½¿ãˆã°ã€è‡ªåˆ†å°‚ç”¨ã®ãƒã‚¤ã‚¯ãƒ­ãƒ–ãƒ­ã‚°ã‚’ç«‹ã¡ä¸Šã’ã€ãã‚Œã‚’è‡ªåˆ†ã§ç®¡ç†ã§ãã‚‹ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ‰€æœ‰æ¨©ã‚’å®Œå…¨ã«ä¿æŒã—ã€å¤–éƒ¨ã®åˆ¶ç´„ã‚„ãƒªã‚¹ã‚¯ã‹ã‚‰è§£æ”¾ã•ã‚Œã‚‹ã€‚
ã¾ãŸã€ä»–ã® Fediverse ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ç¹‹ãŒã‚ŠãªãŒã‚‰ã‚‚ã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§æŠ•ç¨¿ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã‚‚ç´ æ™´ã‚‰ã—ã„ã€‚

ã‹ãã—ã¦ã€ç§ã¯è‡ªåˆ†å°‚ç”¨ã®ãƒã‚¤ã‚¯ãƒ­ãƒ–ãƒ­ã‚°ã‚’ç«‹ã¡ä¸Šã’ã‚‹æ±ºæ„ã‚’å›ºã‚ãŸã€‚

â€» â†“ ãŒä»Šå›ç«‹ã¡ä¸Šã’ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚

https://mastodon.kkhys.me/@kkhys

## æŠ€è¡“é¸å®š

### ã©ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ä½¿ã†ã‹

Fediverse ã®æ§‹æˆè¦ç´ ã® 1 ã¤ã¨ãªã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é¸å®šã™ã‚‹ã«ã‚ãŸã£ã¦ã€[FLOSS](https://ja.wikipedia.org/wiki/FLOSS) ã§ã‚ã‚‹ã“ã¨ã¯å‰ææ¡ä»¶ã§ã‚ã‚‹ã€‚

ãã®ä¸Šã§ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’é¸ã‚“ã§ã„ãã‚ã‘ã ãŒã€ç¾åœ¨ Fediverse ã§æœ€ã‚‚åºƒãæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚ã‚‹ ActivityPub ã‚’é¸ã¶ã®ãŒè‡ªç„¶ã®æµã‚Œã ã¨æ€ã†ã€‚
æœ€è¿‘ã§ã¯ Threads ã‚‚ ActivityPub ã«å¯¾å¿œã—ãŸã—ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆã ãŒï¼‰ã€Tumblr ã‚‚ä»Šå¾Œå¯¾å¿œã™ã‚‹äºˆå®šãªã®ã§å°†æ¥æ€§ã‚‚ã‚ã‚‹ã€‚

ActivityPub ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ãŸãã•ã‚“ã‚ã‚‹ãŒã€æ¶ˆå»æ³•ã§ Mastodon ã«ã—ãŸã€‚
Misskey ã‚‚é¸æŠè‚¢ã® 1 ã¤ã ã£ãŸãŒã€ç ´å£Šçš„å¤‰æ›´ãŒå¤šã„ã®ã¨ã€ç‹¬ç‰¹ã®æ–‡åŒ–ãŒåˆã‚ãªã„ã¨æ„Ÿã˜ãŸã®ã§æ­¢ã‚ãŸã€‚

ä»–ã«ã‚‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ Elixir ã§æ›¸ã‹ã‚ŒãŸ [Pleroma](https://pleroma.social) ã¨ã„ã£ãŸæŠ€è¡“çš„èˆˆå‘³ã‚’æƒ¹ã‹ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚‚ã‚ã‚‹ã€‚
ä»Šå¾Œã€ç§»è¡Œã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŒã€ã²ã¨ã¾ãš Mastodon ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã—ã¦ã„ãã€‚

### ã©ã®ã‚µãƒ¼ãƒã‚’ä½¿ã†ã‹

Mastodon ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ã¯ã€ä»¥å‰ã‹ã‚‰èˆˆå‘³ãŒã‚ã£ãŸ [Vultr](https://www.vultr.com) ã‚’é¸æŠã—ãŸã€‚
**Vultr ã¯åŸºæœ¬çš„ãªæ–™é‡‘ãŒå®‰ã„ã®ã«åŠ ãˆã€æ±äº¬ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ãŒã‚ã‚‹ã“ã¨ãŒå¤§ããªé­…åŠ›ã ã€‚**
ç‰¹ã«ã€ä½ä¾¡æ ¼ãªãƒ—ãƒ©ãƒ³ãŒè±Šå¯Œã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦æ¨¡ã«å¿œã˜ãŸæŸ”è»Ÿãªé¸æŠãŒå¯èƒ½ãªç‚¹ãŒæ°—ã«å…¥ã£ã¦ã„ã‚‹ã€‚

è‚å¿ƒã®ãƒ¡ãƒ¢ãƒªã¯ 2GB ã«ã—ãŸã€‚
Mastodon ã¯ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒå¤šã„ã“ã¨ãŒãƒ‡ãƒ¡ãƒªãƒƒãƒˆã ãŒã€ãŠã²ã¨ã‚Šæ§˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚Œã°ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç›£è¦–ã—ãªãŒã‚‰é©åˆ‡ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã€å•é¡Œãªãé‹ç”¨ã§ãã‚‹ã¨è€ƒãˆã¦ã„ã‚‹ã€‚

**Vultr ã¯ãƒ—ãƒ©ãƒ³ã®å¤šæ§˜æ€§ã‚‚é­…åŠ›ã®ä¸€ã¤ã§ã€å¿…è¦ã«å¿œã˜ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’å¢—ã‚„ã›ã‚‹æŸ”è»Ÿæ€§ãŒã‚ã‚‹ã€‚**
ä»Šå›é¸æŠã—ãŸã®ã¯ High Frequency ãƒ—ãƒ©ãƒ³ã§ã‚ã‚‹ã€‚
ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ 64GB ã® NVMe ã§ã€é«˜é€Ÿãªãƒ‡ãƒ¼ã‚¿è»¢é€ãŒå¯èƒ½ã ã€‚
CPU ã¯ 3GHz ä»¥ä¸Šã® Intel Xeon ã® 1 ã‚³ã‚¢ã‚’é¸ã‚“ã ã€‚
AMD ã® CPU ã‚‚é¸ã¹ã‚‹ãŒã€ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ€§èƒ½ã§ã¯ Intel ãŒä¾ç„¶ã¨ã—ã¦å¼·ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚ã‚Šã€ãã®ä¿¡é ¼æ€§ã«åŸºã¥ã„ã¦ Intel ã‚’é¸æŠã—ãŸã€‚

Mastodon ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã¯ [Cloudflare R2](https://www.cloudflare.com/ja-jp/developer-platform/r2) ã«ä¿å­˜ã™ã‚‹ã€‚
AWS ã® S3 ãŒæ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³•ã§ã‚ã‚‹ãŒã€ã§ãã‚‹ã ã‘æ–™é‡‘ã‚’æŠ‘ãˆãŸã„ã®ã§ R2 ã«ã—ãŸã€‚

### ã©ã® OS ã‚’ä½¿ã†ã‹

Mastodon ã®[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.joinmastodon.org/admin/install) ã§ã¯ã€ä¸»ã« Ubuntu ã‚„ Debian ã¨ã„ã£ãŸãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã€‚
ã“ã‚Œã‚‰ã¯åºƒãä½¿ã‚ã‚Œã¦ãŠã‚Šã€ã‚µãƒãƒ¼ãƒˆã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ã€ç‰¹ã«ã‚µãƒ¼ãƒç’°å¢ƒã«ãŠã„ã¦ã¯éå¸¸ã«å®‰å®šã—ã¦ã„ã‚‹é¸æŠè‚¢ã ã€‚
ã—ã‹ã—ã€å€‹äººçš„ã«æ…£ã‚Œã¦ã„ã‚‹è»½é‡ã‹ã¤ã‚·ãƒ³ãƒ—ãƒ«ãª [Arch Linux](http://www.archlinux.jp) ã‚’ä½¿ã†ã“ã¨ã«æ±ºã‚ãŸã€‚

**æœ¬æ¥ã€Arch Linux ã¯ã‚µãƒ¼ãƒç”¨é€”ã¨ã—ã¦ã¯ã‚ã¾ã‚Šå‘ã„ã¦ã„ãªã„ã¨ã•ã‚Œã¦ã„ã‚‹ã€‚**
ãã®ç†ç”±ã¯ã€ä¸»ã«ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®ç‰¹æ€§ã«ã‚ˆã‚‹ã‚‚ã®ã§ã€é »ç¹ãªæ›´æ–°ã«ã‚ˆã£ã¦äºˆæœŸã›ã¬ãƒˆãƒ©ãƒ–ãƒ«ã‚„äº’æ›æ€§ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã‹ã‚‰ã ã€‚
ä¾‹ãˆã°ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°ãŒåŸå› ã§ä¾å­˜é–¢ä¿‚ãŒå´©ã‚ŒãŸã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«åœæ­¢ã—ãŸã‚Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ã“ã‚Œã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®å‹•ç”»ã§è©³ã—ãè§£èª¬ã•ã‚Œã¦ã„ã‚‹ã€‚

https://www.youtube.com/watch?v=_n9uwYRzDZQ

ãã‚Œã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€Arch Linux ã‚’ä½¿ã†ç†ç”±ã¯ã€å˜ç´”ã«ã€Œ[Arch ã¯æœ€é«˜](https://wiki.archlinux.jp/index.php/Arch_%E3%81%AF%E6%9C%80%E9%AB%98)ã€ã¨æ€ã£ã¦ã„ã‚‹ã‹ã‚‰ã«ä»–ãªã‚‰ãªã„ã€‚
Arch ã®ãƒŸãƒ‹ãƒãƒ«ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã€ãã—ã¦ä½•ã‚ˆã‚Šã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®è‡ªç”±åº¦ã¯ã€ä»–ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯å¾—ã‚‰ã‚Œãªã„ã‚‚ã®ã ã€‚

ã¨ã¯ã„ãˆã€åŸºæœ¬çš„ãªè€ƒãˆæ–¹ã‚„æ“ä½œã¯ã€ã©ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚‚å…±é€šã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒå¤šã„ã€‚
Mastodon ã®ã‚ˆã†ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ã€æ§˜ã€…ãªç’°å¢ƒã§å‹•ä½œã™ã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç‰¹å®šã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãè‡ªç”±ã«é¸ã¶ã“ã¨ãŒã§ãã‚‹ã€‚
ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚Œã°ã€å¥½ããªã®ã‚’ä½¿ãˆã°è‰¯ã„ã¨æ€ã†ã€‚

### è‚å¿ƒã®æ–™é‡‘

Vultr ã§ã‚µãƒ¼ãƒã‚’ 1 ãƒ¶æœˆé–“ã€24 æ™‚é–“ãƒ•ãƒ«ç¨¼åƒã•ã›ãŸå ´åˆã€åŸºæœ¬æ–™é‡‘ã¨ã—ã¦ $12 ã‹ã‹ã‚‹ã€‚
ç¾åœ¨ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’è€ƒæ…®ã™ã‚‹ã¨ã€å††å®‰ã®å½±éŸ¿ã§ $1 ã¯ãŠã‚ˆã Â¥145 ã¨ãªã‚Šã€æœˆé¡ã®è²»ç”¨ã¯ç´„ 1,750 å††ã«ãªã‚‹ã€‚

ç”»åƒç­‰ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã§ã‚ã‚‹ R2 ã§ã¯å¾“é‡èª²é‡‘åˆ¶ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€ç‰¹ç­†ã™ã¹ãã¯ã‚¨ã‚°ãƒ¬ã‚¹æ–™é‡‘ãŒç„¡æ–™ã§ã‚ã‚‹ã“ã¨ã ã€‚
ã‚¨ã‚°ãƒ¬ã‚¹æ–™é‡‘ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¤–éƒ¨ã«å‡ºã™éš›ã«ç™ºç”Ÿã™ã‚‹è²»ç”¨ã®ã“ã¨ã§ã€ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã¯ä¸€èˆ¬çš„ã«ç™ºç”Ÿã™ã‚‹æ–™é‡‘ã§ã‚ã‚‹ã€‚
ã—ã‹ã—ã€R2 ã§ã¯ã“ã®ã‚¨ã‚°ãƒ¬ã‚¹æ–™é‡‘ãŒã‹ã‹ã‚‰ãªã„ãŸã‚ã€ã‚³ã‚¹ãƒˆã‚’å¤§å¹…ã«æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

ç‰¹ã«ã€å€‹äººã§é‹ç”¨ã™ã‚‹ Mastodon ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãŠã„ã¦ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒå¤§é‡ã«ç”»åƒã‚’æŠ•ç¨¿ã—ãªã„é™ã‚Šã€R2 ã®ç„¡æ–™åˆ©ç”¨æ å†…ã§ååˆ†ã«ã‚„ã‚Šãã‚Šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã ã€‚
ãƒ‰ãƒ¡ã‚¤ãƒ³ä»£ã‚’é™¤ã„ã¦ã€å®Ÿè³ª Vultr ã®æ–™é‡‘ã—ã‹ã‹ã‹ã‚‰ãªã„ã€‚
æ¯æœˆæ‰•ã†ã«ã¯ã¾ã‚ã¾ã‚é«˜ã„é‡‘é¡ã ãŒã€ã“ã‚Œã‚ˆã‚Šä½ã„é‡‘é¡ã®ã‚µãƒ¼ãƒã ã¨æº€è¶³ã§ãã‚‹ã‚¹ãƒšãƒƒã‚¯ãŒãªã„ã‹ã‚‰ä»•æ–¹ãªã„ã€‚

## Mastodon ã®æ§‹ç¯‰æ–¹æ³•

æ—©é€Ÿ Mastodon ã‚’æ§‹ç¯‰ã—ã¦ã„ãã€‚
å®Ÿè¡Œç’°å¢ƒã¯ macOSã€‚

ã¾ãšã¯ SSH ã‚’ä½¿ã£ã¦ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒã«æ¥ç¶šã™ã‚‹ã€‚

```shell
ssh root@123.456.78.90
```

Vultr ã‹ã‚‰ç™ºè¡Œã•ã‚ŒãŸ root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿µã®ç‚ºã€å¤‰æ›´ã—ã¦ãŠãã€‚

```shell
passwd
```

æ¬¡ã«ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒã¨ã®æ¥ç¶šã‚’åˆ‡ã£ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ã‚§ãƒ«ã«æˆ»ã‚‹ã€‚
ãã—ã¦ã€æ–°ã—ã„ SSH ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã€‚
æœ€å¾Œã«ã€ä½œæˆã—ãŸ SSH ã‚­ãƒ¼ã®å…¬é–‹éµã‚’ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒã«è¿½åŠ ã—ã¦ã€å…¬é–‹éµèªè¨¼ã‚’è¿½åŠ ã™ã‚‹ã€‚

```shell
exit

ssh-keygen -t ed25519 -C "your_email@example.com"

ssh-copy-id -i ~/.ssh/id_ed25519_vultr.pub root@123.456.78.90
```

ã“ã‚Œã§ã€ä»Šå¾Œãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ã«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ä»£ã‚ã‚Šã«å…¬é–‹éµèªè¨¼ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ã“ã‚Œã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å‘ä¸Šã‚„åˆ©ä¾¿æ€§ã®ãŸã‚ã«å¿…ãšè¡Œã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã§ã‚ã‚‹ã€‚

å¿…è¦ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `.ssh/config` ã‚’å¤‰æ›´ã—ã¦ãŠãã¨å¾Œã€…ã®ä½œæ¥­ãŒæ¥½ã«ãªã‚‹ã€‚

```text title=".ssh/config" showLineNumbers
Host vultr
  Hostname 123.456.78.90
  User root # å¾Œã§ mastodon ã«å¤‰æ›´ã™ã‚‹
  Port 22
  IdentityFile ~/.ssh/id_ed25519_vultr
```

ä¸Šè¨˜ã®è¨­å®šã‚’ã—ãŸä¸Šã§å†åº¦ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒã«æ¥ç¶šã™ã‚‹ã€‚

```shell
ssh vultr
```

Vultr ã® Arch Linux ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãŠãã€‚

ã¾ãšã¯ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŠ¶æ³ã‹ã‚‰ã€‚

```shell
free

               total        used        free      shared  buff/cache   available
Mem:         2013236      258740     1732296         828      162000     1754496
Swap:        6451196           0     6451196

```

ã‚ã‚ŠãŒãŸã„ã“ã¨ã«ã€åˆã‚ã‹ã‚‰ã‚¹ãƒ¯ãƒƒãƒ—ãŒ 6GB è¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚

æ¬¡ã«ã€ã‚«ãƒ¼ãƒãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã€‚

```shell
uname -r
6.6.42-1-lts

pacman -Syu

reboot

uname -r
6.6.45-1-lts
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•ç›´å¾Œã¯ã‚«ãƒ¼ãƒãƒ«ãŒå¤ããªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€åˆã‚ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ä½µã›ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãŠãã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§ã‚’å‡ºåŠ›ã€‚

```shell
pacman -Q

acl 2.3.2-1
archlinux-keyring 20240709-1
argon2 20190702-6
attr 2.5.2-1
audit 4.0.1-3
autoconf 2.72-1
automake 1.17-1
base 3-2
base-devel 1-1
bash 5.2.032-1
bind 9.20.0-1
binutils 2.43+r4+g7999dae6961-1
bison 3.8.2-6
brotli 1.1.0-2
bzip2 1.0.8-6
ca-certificates 20240618-1
ca-certificates-mozilla 3.103-1
ca-certificates-utils 20240618-1
cdrtools 3.02a09-6
cloud-guest-utils 0.33-2
cloud-image-utils 0.33-2
cloud-init 24.1-2
cloud-utils 0.33-2
coreutils 9.5-1
cracklib 2.10.2-1
cronie 1.7.2-1
cryptsetup 2.7.4-1
curl 8.9.1-2
db5.3 5.3.28-5
dbus 1.14.10-2
dbus-broker 36-4
dbus-broker-units 36-4
dbus-units 36-4
debugedit 5.0-6
device-mapper 2.03.25-2
dhclient 4.4.3.P1-3
diffutils 3.10-1
ding-libs 0.6.2-2
dnssec-anchors 20190629-4
duktape 2.7.0-7
e2fsprogs 1.47.1-4
efibootmgr 18-3
efivar 39-1
ethtool 1:6.9-1
expat 2.6.2-1
expect 5.45.4-5
fakeroot 1.35-1
file 5.45-1
filesystem 2024.04.07-1
findutils 4.10.0-1
flex 2.6.4-5
fuse-common 3.16.2-1
fuse3 3.16.2-1
gawk 5.3.0-1
gc 8.2.6-1
gcc 14.2.1+r32+geccf707e5ce-1
gcc-libs 14.2.1+r32+geccf707e5ce-1
gdbm 1.24-1
gettext 0.22.5-1
git 2.46.0-1
glib2 2.80.4-1
glibc 2.40+r16+gaa533d58ff-2
gmp 6.3.0-2
gnu-netcat 0.7.1-10
gnupg 2.4.5-4
gnutls 3.8.6-1
gpgme 1.23.2-6
gpm 1.20.7.r38.ge82d1a6-6
gptfdisk 1.0.10-1
grep 3.11-1
groff 1.23.0-6
grub 2:2.12-2
gssproxy 0.9.2-1
guile 3.0.10-1
gzip 1.13-4
hwdata 0.385-1
iana-etc 20240612-1
icu 75.1-1
iotop 0.6-11
iproute2 6.10.0-2
iptables-nft 1:1.8.10-2
iputils 20240117-1
jansson 2.14-4
jemalloc 1:5.3.0-4
jq 1.7.1-2
json-c 0.17-2
kbd 2.6.4-1
keyutils 1.6.3-3
kmod 32-1
krb5 1.21.3-1
less 1:661-1
libaio 0.3.113-3
libarchive 3.7.4-1
libassuan 3.0.0-1
libbpf 1.4.3-1
libcap 2.70-1
libcap-ng 0.8.5-2
libdaemon 0.14-6
libedit 20240517_3.1-1
libelf 0.191-4
libevent 2.1.12-4
libffi 3.4.6-1
libgcrypt 1.11.0-2
libgpg-error 1.50-1
libidn2 2.3.7-1
libisl 0.26-2
libksba 1.6.7-1
libldap 2.6.8-1
libmaxminddb 1.10.0-1
libmm-glib 1.22.0-1
libmnl 1.0.5-2
libmpc 1.3.1-2
libndp 1.9-1
libnetfilter_conntrack 1.0.9-2
libnewt 0.52.24-2
libnfnetlink 1.0.2-2
libnftnl 1.2.7-1
libnghttp2 1.62.1-1
libnghttp3 1.4.0-1
libnl 3.10.0-1
libnm 1.48.8-1
libnsl 2.0.1-1
libp11-kit 0.25.5-1
libpcap 1.10.4-1
libpgm 5.3.128-3
libpipeline 1.5.7-2
libpsl 0.21.5-2
libpwquality 1.4.5-5
libsasl 2.1.28-4
libseccomp 2.5.5-3
libsecret 0.21.4-1
libsodium 1.0.20-1
libssh2 1.11.0-1
libsysprof-capture 46.0-4
libtasn1 4.19.0-2
libteam 1.32-2
libtirpc 1.3.5-1
libtool 2.5.1-2
libunistring 1.2-1
liburcu 0.14.0-2
liburing 2.6-2
libusb 1.0.27-1
libutempter 1.2.1-4
libuv 1.48.0-2
libverto 0.3.2-5
libxcrypt 4.4.36-2
libxml2 2.13.3-1
libyaml 0.2.5-3
licenses 20240728-1
linux-api-headers 6.10-1
linux-firmware 20240703.e94a2a3b-1
linux-firmware-whence 20240703.e94a2a3b-1
linux-lts 6.6.45-1
linux-lts-headers 6.6.45-1
lmdb 0.9.32-1
lsof 4.99.3-2
lvm2 2.03.25-2
lz4 1:1.10.0-2
m4 1.4.19-3
make 4.4.1-2
man-db 2.12.1-1
mkinitcpio 39.2-2
mkinitcpio-busybox 1.36.1-1
mobile-broadband-provider-info 20240407-1
mpdecimal 4.0.0-2
mpfr 4.2.1-4
nano 8.1-1
ncurses 6.5-3
net-tools 2.10-2
nettle 3.10-1
networkmanager 1.48.8-1
nfs-utils 2.6.4-1
nfsidmap 2.6.4-1
nftables 1:1.1.0-2
npth 1.7-1
nspr 4.35-3
nss 3.103-1
numactl 2.0.18-1
oniguruma 6.9.9-1
openssh 9.8p1-1
openssl 3.3.1-1
p11-kit 0.25.5-1
pacman 6.1.0-3
pacman-mirrorlist 20240717-1
pacutils 0.14.0-1
pahole 1:1.27-2
pam 1.6.1-2
pambase 20230918-1
parted 3.6-2
patch 2.7.6-10
pciutils 3.13.0-1
pcre 8.45-4
pcre2 10.44-1
pcsclite 2.3.0-1
perl 5.38.2-2
perl-clone 0.46-3
perl-data-dump 1.25-5
perl-encode-locale 1.05-12
perl-error 0.17029-6
perl-file-listing 6.16-3
perl-html-parser 3.82-1
perl-html-tagset 3.24-1
perl-http-cookiejar 0.014-2
perl-http-cookies 6.11-1
perl-http-daemon 6.16-3
perl-http-date 6.06-2
perl-http-message 6.46-1
perl-http-negotiate 6.01-13
perl-io-html 1.004-5
perl-io-socket-ssl 2.085-1
perl-json 4.10-2
perl-libwww 6.77-1
perl-log-message 0.08-10
perl-log-message-simple 0.10-10
perl-lwp-mediatypes 6.04-5
perl-lwp-protocol-https 6.14-1
perl-mailtools 2.21-8
perl-net-http 6.23-3
perl-net-ssleay 1.94-1
perl-term-readline-gnu 1.46-3
perl-term-ui 0.50-4
perl-timedate 2.33-6
perl-try-tiny 0.31-4
perl-uri 5.28-1
perl-www-robotrules 6.02-13
pinentry 1.3.1-5
pkgconf 2.1.1-1
polkit 125-1
popt 1.19-1
procps-ng 4.0.4-3
psmisc 23.7-1
python 3.12.4-1
python-attrs 23.2.0-3
python-cffi 1.16.0-2
python-charset-normalizer 3.3.2-2
python-configobj 5.0.8-5
python-cryptography 42.0.6-1
python-filelock 3.13.3-2
python-idna 3.7-1
python-jinja 1:3.1.4-1
python-jsonpatch 1.33-2
python-jsonpointer 3.0.0-1
python-jsonschema 4.23.0-1
python-jsonschema-specifications 2023.12.1-2
python-markupsafe 2.1.5-2
python-netifaces 0.11.0-5
python-oauthlib 3.2.2-3
python-packaging 24.1-1
python-pip 24.2-1
python-pycparser 2.22-2
python-pyrsistent 0.19.3-4
python-pyserial 3.5-6
python-referencing 0.35.1-1
python-requests 2.32.3-1
python-rpds-py 0.19.0-1
python-six 1.16.0-9
python-typing_extensions 4.12.2-1
python-urllib3 1.26.19-1
python-wheel 0.44.0-1
python-yaml 6.0.1-4
qemu-img 9.0.2-1
readline 8.2.013-1
reflector 2023-2
rpcbind 1.2.7-1
run-parts 5.17-1
screen 4.9.1-2
sed 4.9-3
shadow 4.16.0-1
slang 2.3.3-3
sqlite 3.46.0-1
sudo 1.9.15.p5-2
systemd 256.4-1
systemd-libs 256.4-1
systemd-sysvcompat 256.4-1
tar 1.35-2
tcl 8.6.14-4
texinfo 7.1-2
thin-provisioning-tools 1.1.0-1
tpm2-tss 4.0.1-1
trizen 1:1.68-1
tzdata 2024a-2
ufw 0.36.2-4
unzip 6.0-21
util-linux 2.40.2-1
util-linux-libs 2.40.2-1
vim 9.1.0672-1
vim-runtime 9.1.0672-1
watchdog 5.16-2
wget 1.24.5-3
which 2.21-6
wpa_supplicant 2:2.11-2
xz 5.6.2-1
zeromq 4.3.5-2
zip 3.0-11
zlib 1:1.3.1-2
zstd 1.5.6-1
```

Arch Linux ã¨ã„ãˆã°ã€æœ€åˆã¯ä½•ã‚‚å…¥ã£ã¦ã„ãªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã ã£ãŸãŒã€è¦ªåˆ‡ã«ã‚‚å¿…è¦æœ€ä½é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚‹ã€‚
æ­£ç›´ãªã¨ã“ã‚ã€ã‚ã‚ŠãŒãŸè¿·æƒ‘ã€‚

æ¬¡ã«æ—¥ä»˜ã®è¨­å®šã‚’è¡Œã£ã¦ã„ãã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ UTC ãªã®ã§ã€ã“ã‚Œã‚’ JSTï¼ˆæ—¥æœ¬æ¨™æº–æ™‚ï¼‰ã«å¤‰æ›´ã™ã‚‹ã€‚

```shell
date
Tue Aug 13 06:11:30 AM UTC 2024

ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

date
Tue Aug 13 03:12:01 PM JST 2024
```

æ¬¡ã«ãƒ­ã‚±ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `en_US` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
ã¾ãŸã€ã‚·ã‚¹ãƒ†ãƒ ã§åˆ©ç”¨å¯èƒ½ãªãƒ­ã‚±ãƒ¼ãƒ«ã«ã¯ `ja_JP` ãŒãªã„ãŸã‚ã€`/etc/locale.gen` ã«è¿½åŠ ãŒå¿…è¦ã€‚

```shell
echo $LANG
en_US.UTF-8

locale -a
C
C.utf8
en_US.utf8
POSIX

vim /etc/locale.gen
```

```text title="/etc/locale.gen"
ja_JP.UTF-8 UTF-8 // [!code ++]
```

`locale-gen` ã§ã‚·ã‚¹ãƒ†ãƒ ã§åˆ©ç”¨ã§ãã‚‹ãƒ­ã‚±ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

```shell
locale-gen

locale -a
C
C.utf8
en_US.utf8
ja_JP.utf8
POSIX
```

`locale -a` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `ja_JP` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€‚

æ¬¡ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚±ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã« `/etc/locale.conf` ã‚’ä¿®æ­£ã™ã‚‹ã€‚

```shell
vim /etc/locale.conf
```

```text title="/etc/locale.conf"
# LANG=en_US.UTF-8 // [!code --]
LANG=ja_JP.UTF-8 // [!code ++]
```

æœ€å¾Œã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†èµ·å‹•ã•ã›ã‚‹ã“ã¨ã§å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã€‚

```shell
reboot
```

ä¸€å¿œã€ç¢ºèªã€‚

```shell
echo $LANG
ja_JP.UTF-8
```

root ã«ç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã®ã¯å¥½ã¾ã—ããªã„ã®ã§ mastodon ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã€‚
ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã¯ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ— wheel ã«æ‰€å±ã•ã›ã‚‹ã€‚

[systemd-homed](https://wiki.archlinux.jp/index.php/Systemd-homed) ã¨ã„ã†æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ç®¡ç†æ–¹æ³•ã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯æ…£ã‚Œã¦ã„ã‚‹å¤å…¸çš„ãªæ–¹æ³•ã§ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ãŸã€‚

```shell
useradd -mg wheel mastodon

passwd mastodon
```

wheel ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¦ãƒ¼ã‚¶ãŒ sudo ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ä¸€æ™‚çš„ã«ç‰¹æ¨©ã‚’å¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€`/etc/sudoers` ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã‚’è¡Œã†ã€‚

```shell
EDITOR=vim visudo
```

`sudo` ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’è¦æ±‚ã•ã‚Œãªã„ã»ã†ãŒä½¿ã„ã‚„ã™ã„ã®ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã¯å¼±ããªã‚‹ãŒã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãªã—ã§ `sudo` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã€‚

```text title="/etc/sudoers"
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL // [!code --]
%wheel ALL=(ALL:ALL) NOPASSWD: ALL // [!code ++]
```

æ¬¡ã¯ SSH æ¥ç¶šæ™‚ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã€‚

```shell
vim /etc/ssh/sshd_config
```

`PermitRootLogin no` ã¨è¨­å®šã™ã‚‹ã“ã¨ã§ã€root ãƒ¦ãƒ¼ã‚¶ãŒç›´æ¥ãƒªãƒ¢ãƒ¼ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã—ã¦ã„ã‚‹ã€‚
ã¾ãŸã€`PasswordAuthentication no` ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸãƒ­ã‚°ã‚¤ãƒ³ã‚’ç„¡åŠ¹ã«ã—ã€å…¬é–‹éµãªã©ã®èªè¨¼æ–¹å¼ã‚’ç”¨ã„ã‚‹ã“ã¨ã‚’å¼·åˆ¶ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ãŸã€‚
ã“ã‚Œã¯å…¬é–‹éµã‚’ç´›å¤±ã—ãŸã‚‰äºŒåº¦ã¨ã‚µãƒ¼ãƒã«ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚

```text title="/etc/ssh/sshd_config"
PermitRootLogin yes // [!code --]
PermitRootLogin no // [!code ++]

PasswordAuthentication yes // [!code --]
PasswordAuthentication no // [!code ++]
```

æœ€å¾Œã« SSH ã‚µãƒ¼ãƒã‚’æœ‰åŠ¹åŒ–ã—ã¦ä¸Šè¨˜ã®è¨­å®šã‚’åæ˜ ã•ã›ã‚‹ã€‚

```shell
systemctl restart sshd
```

æ¬¡ã«ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚„æ”»æ’ƒã‹ã‚‰ã‚µãƒ¼ãƒã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ [fail2ban](https://github.com/fail2ban/fail2ban) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
pacman -S fail2ban
```

fail2ban ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä¸€èˆ¬çš„ã« `jail.conf` ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šãŒè¨˜è¿°ã•ã‚Œã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãŒå¤‰æ›´ã‚’åŠ ãˆã‚‹å ´åˆã¯ `jail.local` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã‚’ã‚³ãƒ”ãƒ¼ã—ã€ãã®ã‚³ãƒ”ãƒ¼ã‚’ç·¨é›†ã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã«å€£ã†ã€‚

```shell
cp /etc/fail2ban/jail.{conf,local}

vim /etc/fail2ban/jail.local
```

ä»¥ä¸‹ã®ç·¨é›†ã‚’ã—ã¦ã€SSH ã‚µãƒ¼ãƒã®ç›£è¦–ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ã€‚

```text title="/etc/fail2ban/jail.local"
[sshd]
enabled = true
mode = aggressive
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ fail2ban ã‚µãƒ¼ãƒ“ã‚¹ã‚’å³åº§ã«èµ·å‹•ã—ã€ã•ã‚‰ã«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«é–‹å§‹ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚


```shell
systemctl enable --now fail2ban
```

ç¾åœ¨ fail2ban ãŒã‚·ã‚¹ãƒ†ãƒ ä¸Šã§ã©ã®ã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

```shell
fail2ban-client status

Status
|- Number of jail:      1
`- Jail list:   sshd
```

SSH ãƒ‡ãƒ¼ãƒ¢ãƒ³ã«å¯¾ã—ã¦ç›£è¦–ã¨ä¿è­·ã‚’è¡Œã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€‚

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã‹ã‚‰ 1 é€±é–“ãã‚‰ã„çµŒã£ãŸã®ã§ã€ã©ã‚Œãã‚‰ã„åŠ¹æœãŒã‚ã£ãŸã®ã‹ç¢ºã‹ã‚ã¦ã¿ã‚‹ã€‚

```shell
fail2ban-client status sshd

Status for the jail: sshd
|- Filter
|  |- Currently failed: 4
|  |- Total failed:     8110
|  - Journal matches:  _SYSTEMD_UNIT=sshd.service + _COMM=sshd
- Actions
   |- Currently banned: 1
   |- Total banned:     811
   - Banned IP list:   xxx.xxx.xxx.xxx
```

è¦ç‚¹ã ã‘ç¢ºèªã™ã‚‹ã¨ã€fail2ban ãŒç¨¼åƒã—ã¦ã„ã‚‹æœŸé–“ä¸­ã«ã€SSH æ¥ç¶šãŒå¤±æ•—ã—ãŸå›æ•°ã®åˆè¨ˆãŒ 8,110 å›ã€811 ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚
æ€ã£ã¦ã„ãŸã‚ˆã‚Šã‚‚å¤šã„ã€‚

IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«ã€è‡ªåˆ†å®›ã«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒã€ã‚ã¾ã‚Šã«ä»¶æ•°ãŒå¤šã„ãŸã‚æœ‰åŠ¹ã«ã—ã¦ã„ãªã„ã€‚

fail2ban ã§ã¯ä¸€åº¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€è¨­å®šã•ã‚ŒãŸæ™‚é–“ãŒçµŒéã™ã‚‹ã¨è‡ªå‹•çš„ã«è§£é™¤ã•ã‚Œã‚‹ã€‚
ã“ã®æ™‚é–“ã¯ç´°ã‹ãå¤‰æ›´å¯èƒ½ã€‚
æ°¸ä¹…ã«ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ãªã®ã§ã€é »ç¹ã«åŒã˜ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ”»æ’ƒã‚’è©¦ã¿ã¦ã„ã‚‹å ´åˆã¯ã€å¯¾å¿œã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚

æ¬¡ã« nftables ã‚’ä½¿ã£ã¦ã€ãƒ‘ã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œãªã£ã¦ã„ãã€‚

Vultr ã§ç«‹ã¡ä¸Šã’ãŸ Arch Linux ã«ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ nftables ã¨ iptables-nft ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãŸã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¾åœ¨å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚

```shell
nft list tables

table ip filter
table ip6 filter
```

iptables-nft ã¯ä½¿ã‚ãªã„ãŸã‚ã€nftables ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ `/etc/nftables.conf` ã‚’ç·¨é›†ã—ã¦ã€è‡ªåˆ†ã§ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ã„ãã€‚

```shell
vim /etc/nftables.conf
```

è¨­å®šã®æ„å‘³ã¯ã‚³ãƒ¼ãƒ‰å†…ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¨˜è¼‰ã—ãŸã€‚

```text title="/etc/nftables.conf" showLineNumbers
#!/usr/sbin/nft -f
# vim:set ts=2 sw=2 et:

# ç¾åœ¨ã®å…¨ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒã‚§ãƒ¼ãƒ³ã€ãƒ«ãƒ¼ãƒ«ï¼‰ã‚’å‰Šé™¤
flush ruleset

table inet filter {
    # å—ä¿¡ãƒ‘ã‚±ãƒƒãƒˆã«å¯¾ã—ã¦é©ç”¨ã•ã‚Œã‚‹è¨­å®š
    chain input {
        # å„ªå…ˆåº¦ã¯ 0 ã§ã‚ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒªã‚·ãƒ¼ã¯ drop
        # ã“ã‚Œã¯ã€å—ä¿¡ãƒ‘ã‚±ãƒƒãƒˆãŒã“ã®ãƒã‚§ãƒ¼ãƒ³ã«åˆ°é”ã—ãŸå ´åˆã€ãƒ«ãƒ¼ãƒ«ã«ä¸€è‡´ã—ãªã„é™ã‚Šã€å…¨ã¦ã®ãƒ‘ã‚±ãƒƒãƒˆã‚’æ‹’å¦ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã™ã‚‹
        type filter hook input priority 0; policy drop;

        # ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚‚ã®ã ã‘ã«åˆ¶é™ã—ã€ãã‚Œä»¥å¤–ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ã
        iif "lo" accept
        ip daddr 127.0.0.0/8 iif != "lo" reject

        # ã™ã§ã«ç¢ºç«‹ã•ã‚ŒãŸã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚„æ—¢å­˜ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã«é–¢é€£ã™ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã‚’è¨±å¯ã™ã‚‹
        # ã“ã‚Œã«ã‚ˆã‚Šã€æ­£å¸¸ãªé€šä¿¡ã®æµã‚ŒãŒç¶­æŒã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé€”åˆ‡ã‚ŒãŸã‚Šä¸­æ–­ã•ã‚ŒãŸã‚Šã™ã‚‹ã“ã¨ãŒé˜²ã
        ct state established,related accept

        # ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãŒ HTTP ãŠã‚ˆã³ HTTPS ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        tcp dport 80 accept
        tcp dport 443 accept

        # ç‰¹å®šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒ UDP ãƒãƒ¼ãƒˆ 443 ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã«ãã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯ã™ã‚‹
        udp dport 443 accept

        # ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ã® SSH æ¥ç¶šè¦æ±‚ã‚’å—ã‘å…¥ã‚Œã‚‹
        tcp dport 22 ct state new accept

        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç¢ºèªã‚„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ã«ã€å¤–éƒ¨ã‹ã‚‰ã® ping è¦æ±‚ã‚’å—ã‘å…¥ã‚Œã‚‹
        icmp type echo-request accept

        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã®éšœå®³ã‚„ã‚¨ãƒ©ãƒ¼ã‚’è¨ºæ–­ã™ã‚‹ã®ã«å½¹ç«‹ã¤æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹
        # Allow destination unreachable messages, especially code 4 (fragmentation required) is required or PMTUD breaks
        icmp type destination-unreachable accept

        # nftables ã§ãƒ‘ã‚±ãƒƒãƒˆãŒã“ã®ãƒ«ãƒ¼ãƒ«ã«ä¸€è‡´ã—ãŸå ´åˆã€nftables denied: ã¨ã„ã†ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãã§ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã€1 åˆ†é–“ã«æœ€å¤§ 5 å›ã®ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹
        limit rate 5/minute log prefix "nftables denied: " level debug

        # ä¸Šè¨˜ã§è¨­å®šã—ãŸãƒ«ãƒ¼ãƒ«ã«æ²¿ã‚ãªã„å ´åˆã¯æ¥ç¶šã‚’æ‹’å¦ã™ã‚‹
        reject
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ nftables ã‚µãƒ¼ãƒ“ã‚¹ã‚’å³åº§ã«èµ·å‹•ã—ã€ã•ã‚‰ã«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«é–‹å§‹ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚

```shell
systemctl enable --now nftables
```

nftables ã®è¨­å®šãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã€‚
ã¾ãšã¯æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‹ã‚‰ã€‚

```shell
nft -c -f /etc/nftables.conf
```

å•é¡Œãªã‘ã‚Œã°ã€ç‰¹ã«ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ã€‚
å¿µã®ç‚ºã€ç¾åœ¨ã®è¨­å®šã‚’ç¢ºèªã™ã‚‹ã€‚

```shell
nft list ruleset
```

å…ˆã»ã©è¨­å®šã—ãŸå†…å®¹ãŒåæ˜ ã•ã‚Œã¦ã„ã‚Œã° OKã€‚

æ¬¡ã«ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

```shell
dmesg | grep "nftables denied:"

[631369.913820] nftables denied: IN=xxx OUT=xxx MAC=xxx SRC=xxx DST=xxx LEN=xxx TOS=xxx PREC=xxx TTL=xxx ID=xxx PROTO=xxx SPT=xxx DPT=xxx WINDOW=xxx RES=xxx SYN URGP=xxx
```

ä¸Šè¨˜ã®ã‚ˆã†ãªå½¢å¼ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚Œã°æ­£å¸¸ã«è¨­å®šãŒã•ã‚Œã¦ã„ã‚‹ã€‚

ã“ã‚Œã§ nftables ã®è¨­å®šã¯å®Œäº†ã§ã‚ã‚‹ã€‚

æ¬¡ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã€‚

```shell
pacman -S imagemagick ffmpeg postgresql postgresql-libs redis yaml-cpp libxml2 libxslt protobuf pkg-config jemalloc nginx certbot certbot-nginx libidn
```

ä»¥é™ã®å‡¦ç†ã¯ mastodon ãƒ¦ãƒ¼ã‚¶ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰è¡Œã†ã€‚

```shell
su - mastodon
```

Arch Linux ã«æ¨™æº–ã§ä»˜å±ã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã§ã‚ã‚‹ pacman ã¯å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®ã¿å¯¾å¿œã—ã¦ã„ã‚‹ã€‚
å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ‰±ã†ãŸã‚ã« [AUR](https://aur.archlinux.org)ï¼ˆArch User Repositoryï¼‰ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹éå…¬å¼ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã€‚

AUR ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã™ã‚‹ãŸã‚ã€[paru](https://github.com/Morganamilo/paru) ã¨ã„ã† Rust è£½ã® AUR ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ãã€‚
ä»¥ä¸‹ã¯ãã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã€‚

```shell
git clone https://aur.archlinux.org/paru.git

cd paru

less PKGBUILD

makepkg -si

cd ..

rm -rf paru

sudo pacman -Rs rust
```

paru ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ“ãƒ«ãƒ‰ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸è¦ãªã®ã§å‰Šé™¤ã™ã‚‹ã€‚
Rust ã¯ä»Šå¾Œä½¿ã†ã“ã¨ã¯ãªã„ãŸã‚ã€ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã€‚

ç¶šã„ã¦ã€Ruby ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã§ã‚ã‚‹ [rbenv](https://github.com/rbenv/rbenv) ã‚’ AUR ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
paru -S rbenv ruby-build

RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.2.3

rbenv init

echo 'eval "$(rbenv init - bash)"' >> ~/.bash_profile

source ~/.bash_profile

rbenv global 3.2.3

gem install bundler --no-document
```

Ruby ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã¯é«˜æ€§èƒ½ãªãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã§ã‚ã‚‹ [jemalloc](https://jemalloc.net) ã‚’æŒ‡å®šã—ã¦ãŠãã€‚
jemalloc ãŒä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã§å®Ÿè¡Œæ™‚ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ãŒæ”¹å–„ã•ã‚Œã€ç‰¹ã«é«˜è² è·ã®ç’°å¢ƒã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‘ä¸Šã™ã‚‹[^1]ã€‚

[^1]: [Ruby Ã— jemalloc ã®ã™ã™ã‚](https://tech.medpeer.co.jp/entry/ruby-jemalloc)

æ¬¡ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šã‚’è¡Œã†ã®ã§ã€postgres ãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦æ–°ã—ã„ã‚·ã‚§ãƒ«ã‚’é–‹ãã€‚

```shell
sudo -iu postgres
```

postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ã€PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã„ãã€‚
ç’°å¢ƒå¤‰æ•° `$LANG` ã«ã¯å…ˆã»ã©è¨­å®šã—ãŸ `ja_JP.UTF-8` ãŒä½¿ç”¨ã•ã‚Œã‚‹ã€‚

```shell
initdb --locale $LANG -E UTF8 -D '/var/lib/postgres/data'
````

ç¶šã„ã¦ã€PostgreSQL ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã„ãã€‚
å…·ä½“çš„ã«ã¯ã€ã‚µãƒ¼ãƒã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒªã‚½ãƒ¼ã‚¹ã¨ä½¿ç”¨ã‚±ãƒ¼ã‚¹ã«åŸºã¥ã„ã¦ã€æœ€é©ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‹•ä½œã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã«ã¦ã‚µãƒ¼ãƒã®æ§‹æˆã«åŸºã¥ã„ãŸå…¥åŠ›ã‚’è¡Œã†ã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚

https://pgtune.leopard.in.ua

ä»¥ä¸‹ã¯ä»Šå›å‡ºåŠ›ã•ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€‚

```text
# DB Version: 16
# OS Type: linux
# DB Type: web
# Total Memory (RAM): 2 GB
# CPUs num: 1
# Connections num: 100
# Data Storage: ssd

max_connections = 100
shared_buffers = 512MB
effective_cache_size = 1536MB
maintenance_work_mem = 128MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 2621kB
huge_pages = off
min_wal_size = 1GB
max_wal_size = 4GB
```

ã“ã‚Œã‚’ PostgreSQL ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ `postgresql.conf` ã«ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹ã€‚

```shell
vim /var/lib/postgres/data/postgresql.conf

systemctl enable --now postgresql

su - postgres

psql

CREATE USER mastodon CREATEDB;

\q
```

PostgreSQL ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹éš›ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ¦ãƒ¼ã‚¶åã¨åŒã˜åå‰ã«ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€[ident èªè¨¼](https://www.postgresql.jp/docs/11/auth-ident.html) ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ãƒ¦ãƒ¼ã‚¶åãŒä¸€è‡´ã—ã¦ã„ã‚Œã°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãŒä¸è¦ã«ãªã‚‹ãŸã‚æ¥ç¶šãŒã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚‹ã€‚

```shell
exit

systemctl enable --now redis
```

æ¬¡ã«ã€ä¸€æ—¦ postgres ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã€admin ãƒ¦ãƒ¼ã‚¶ã«æˆ»ã‚‹ã€‚
ãã—ã¦ã€ å…ˆã»ã©ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ Redis ã‚’èµ·å‹•ã™ã‚‹ã€‚

å†åº¦ mastodon ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆã¦ã€JavaScript ã®ãƒ„ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ã§ã‚ã‚‹ [Volta](https://volta.sh) ã‚’ä½¿ã£ã¦ Node.js ã‚„ Yarn ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹ã€‚

ã‚‚ã¡ã‚ã‚“ã€ç›´æ¥ curl ã§ Node.js ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚‚è‰¯ã„ã®ã ãŒã€é•·æœŸé‹ç”¨ã—ã¦ã„ãä¸Šã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ãã¯å¿…ãšæ¥ã‚‹ã‚ã‘ã§ã€ãã®ã¨ãã®ãŸã‚ã« Volta ã‚’å…¥ã‚Œã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„ï¼ˆ[nodenv](https://github.com/nodenv/nodenv) ã§ã‚‚è‰¯ã„ã‘ã©ï¼‰ã€‚

```shell
su - mastodon

curl https://get.volta.sh | bash

source ~/.bashrc

volta install node

# ç¾åœ¨ã¯ yarn ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 4 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç‚¹ã«æ³¨æ„
volta install yarn@1
```

ãã—ã¦ã€ã‚ˆã†ã‚„ã Mastodon æœ¬ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã€‚

```shell
git clone https://github.com/mastodon/mastodon.git live && cd live

# æœ€æ–°ã®å®‰å®šç‰ˆã‚¿ã‚°ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
git checkout $(git tag -l | grep '^v[0-9.]*$' | sort -V | tail -n 1)
```

æ¬¡ã« Mastodon ã® Ruby ãŠã‚ˆã³ JavaScript ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®è¨­å®šã¨å®Ÿè¡Œã‚’è¡Œã†ã€‚

```shell
# Gemfile ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ãŒèª­ã¿å–ã‚Šå°‚ç”¨ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€é–‹ç™ºç’°å¢ƒç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯é©ç”¨ã•ã‚Œãªã„
bundle config deployment 'true'

# development ã¨ test ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¾å­˜é–¢ä¿‚ã‚’é™¤å¤–ã™ã‚‹
bundle config without 'development test'

# Gemfile ã«è¨˜è¿°ã•ã‚ŒãŸå¿…è¦ãª Gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
# ã“ã®ã¨ãã€ã‚·ã‚¹ãƒ†ãƒ ã®åˆ©ç”¨å¯èƒ½ãª CPU ã‚³ã‚¢æ•°ã«åŸºã¥ã„ã¦ä¸¦åˆ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã†
bundle install -j$(getconf _NPROCESSORS_ONLN)

# JavaScript ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
# yarn.lock ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã—ãªã„
yarn install --pure-lockfile
```

Mastodon ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã« R2 ã§ CORS ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¦ãŠãã€‚

```json
[
  {
    // ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯ã™ã‚‹
    "AllowedHeaders": [
      "*"
    ],
    // HTTP ãƒ˜ãƒƒãƒ€ã®ã†ã¡ã€GET ã¨ HEAD ã®ã¿è¨±å¯ã™ã‚‹
    "AllowedMethods": [
      "GET",
      "HEAD"
    ],
    // ã©ã®ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚è¨±å¯ã™ã‚‹
    "AllowedOrigins": [
      "*"
    ],
    // ETag ãƒ˜ãƒƒãƒ€ã®ã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«å…¬é–‹ã™ã‚‹
    "ExposeHeaders": [
      "ETag"
    ],
    // ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çµæœã‚’ 3,000 ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
    "MaxAgeSeconds": 3000
  }
]
```

æ¬¡ã« Mastodon ã‚’æœ¬ç•ªç’°å¢ƒã§è¨­å®šã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€Redisã€ãŠã‚ˆã³ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®šã‚’å¯¾è©±å½¢å¼ã§è¡Œãˆã‚‹ã€‚
ç›´æ¥ã€ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã‚‚è‰¯ã„ã‘ã©ã€ç‰¹ã«ç†ç”±ãŒãªã‘ã‚Œã°ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ OKã€‚

```shell
RAILS_ENV=production bundle exec rake mastodon:setup

# ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’æŒ‡å®šã™ã‚‹
Domain name: mastodon.kkhys.me

# ã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã‹ã©ã†ã‹
# ä»Šå›ã¯ãŠã²ã¨ã‚Šæ§˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã®ã§ Yes
Do you want to enable single user mode? (y/N) y

# Docker ã‚’ä½¿ã†ã‹ã©ã†ã‹
Are you using Docker to run Mastodon? (Y/n) n

# PostgreSQL ã®è¨­å®š
PostgreSQL host: /var/run/postgresql
PostgreSQL port: 5432
Name of PostgreSQL database: mastodon_production
Name of PostgreSQL user: mastodon
Password of PostgreSQL user:

# Redis ã®è¨­å®š
Redis host: localhost
Redis port: 6379
Redis password:

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š
# é¸æŠè‚¢ã« R2 ãŒãªã„ã®ã§ã€å¾Œã‹ã‚‰å¤‰æ›´ã™ã‚‹
Provider Amazon S3
S3 bucket name: files-mastodon-kkhys-me
S3 region: auto
S3 hostname: files.mastodon.kkhys.me
S3 access key: xxx
S3 secret key: xxx
Do you want to access the uploaded files from your own domain? Yes
Domain for uploaded files: files.mastodon.kkhys.me

# SMTP ã‚µãƒ¼ãƒã®è¨­å®š
# ä»Šå›ã¯ Gmail ã‚’ä½¿ç”¨ã—ãŸ
Do you want to send e-mails from localhost? No
SMTP server: smtp.gmail.com
SMTP port: 587
SMTP username: xxx@gmail.com
SMTP password: xxx
SMTP authentication: plain
SMTP OpenSSL verify mode: none
Enable STARTTLS: always
E-mail address to send e-mails "from": Mastodon <xxx@gmail.com>
Send a test e-mail with this configuration right now? Yes
Send test e-mail to: xxx

# ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±ãªã©ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ã¦ã‚‚è‰¯ã„ã‹ã©ã†ã‹
# Yes ãŒãŠã™ã™ã‚
Do you want Mastodon to periodically check for important updates and notify you? (Recommended) Yes

# .env.production ã«ä¿å­˜ã—ã¦ã‚‚è‰¯ã„ã‹ã©ã†ã‹
Save configuration? Yes

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’åˆæœŸåŒ–ã—ã¦ã‚‚è‰¯ã„ã‹ã©ã†ã‹
Prepare the database now? Yes

# ã‚¢ã‚»ãƒƒãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ã—ã¦ã‚‚è‰¯ã„ã‹ã©ã†ã‹
Compile the assets now? (Y/n) Yes

# ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹
# ã“ã“ã§ä½œæˆã—ã¦ãŠã„ãŸæ–¹ãŒæ¥½
Do you want to create an admin user straight away? Yes
Username: xxx
E-mail: xxx

# ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ãƒ¡ãƒ¢ã—ã¦ãŠã
You can login with the password: xxx
```

å…ˆã»ã©è¨­å®šã§ããªã‹ã£ãŸ R2 ã«é–¢ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å¤‰æ›´ã™ã‚‹ã€‚

```shell
vim /home/mastodon/live/.env.production
```

ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã€‚

```text title="/home/mastodon/live/.env.production"
S3_ENDPOINT=https://xxx.r2.cloudflarestorage.com/ // [!code ++]
S3_PERMISSION=private // [!code ++]
```

Mastodon ã®æœ€ä½é™ã®è¨­å®šã¯ä»¥ä¸Šã§çµ‚ã‚ã‚Šã€‚

ç¶šã„ã¦ã€Nginx é–¢é€£ã®è¨­å®šã‚’è¡Œãªã£ã¦ã„ãã€‚

SSL/TLS è¨¼æ˜æ›¸ã¯ [Let's Encrypt](https://letsencrypt.org/ja) ã‹ã‚‰å…¥æ‰‹ã™ã‚‹ãŒã€ãã®éš›ã« Let's Encryptã®å…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚ã‚‹ [certbot](https://certbot.eff.org) ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```shell
# ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆ
sudo su -

# Certbot ã‚’ä½¿ç”¨ã—ã¦ã€æŒ‡å®šã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã® SSL/TLS è¨¼æ˜æ›¸ã‚’å–å¾—ã™ã‚‹
# --nginx ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€Nginx ã‚µãƒ¼ãƒã®è¨­å®šã‚’è‡ªå‹•çš„ã«æ¤œå‡ºã—ã€è¨¼æ˜æ›¸ã®å–å¾—ã‚’ç°¡ç´ åŒ–ã™ã‚‹
# ã“ã“ã§ã¯ã€Nginx ãŒæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æ
certbot certonly --nginx -d mastodon.kkhys.me

# Nginx ã®è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹
# sites-available ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ã‚µãƒ¼ãƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®å ´æ‰€
# sites-enabled ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ç¾åœ¨æœ‰åŠ¹ãªã‚µã‚¤ãƒˆã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹å ´æ‰€
mkdir -p /etc/nginx/sites-{available,enabled} /etc/nginx/conf.d

# åˆæœŸçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«å‡ºåŠ›ã™ã‚‹
cat /etc/nginx/nginx.conf
```

åˆæœŸçŠ¶æ…‹ã® Nginx è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

```text title="/etc/nginx/nginx.conf" showLineNumbers
#user http;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
```

ã“ã‚Œã‚’ Mastodon å‘ã‘ã«ç·¨é›†ã—ã¦ã„ãã€‚

```shell
vim /etc/nginx/nginx.conf
```

```text title="/etc/nginx/nginx.conf" showLineNumbers
user http;
worker_processes auto;
worker_cpu_affinity auto;

events {
    multi_accept on;
    worker_connections 1024;
}

http {
    charset utf-8;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    server_tokens off;
    log_not_found off;
    types_hash_max_size 4096;
    client_max_body_size 16M;

    # MIME
    include mime.types;
    default_type application/octet-stream;

    # logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # load configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

æ¬¡ã« Mastodon å´ã§ç”¨æ„ã•ã‚ŒãŸ Nginx è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ãŸã‚ã®å‡¦ç†ã‚’è¡Œã†ã€‚

```shell
# Mastodon ã®ãŸã‚ã® Nginx è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Nginx ã®è¨­å®šç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
cp /home/mastodon/live/dist/nginx.conf /etc/nginx/sites-available/mastodon

# sites-available ã«ã‚ã‚‹ Mastodon ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹
ln -s /etc/nginx/sites-available/mastodon /etc/nginx/sites-enabled/

vim /etc/nginx/sites-available/mastodon
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è¨¼æ˜æ›¸ã¨ã®ç´ä»˜ã‘ãŒã†ã¾ãã„ã‹ãªã„ãŸã‚ã€ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†ã€‚

```text title="/etc/nginx/sites-available/mastodon"
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream backend {
    server 127.0.0.1:3000 fail_timeout=0;
}

upstream streaming {
    # Instruct nginx to send connections to the server with the least number of connections
    # to ensure load is distributed evenly.
    least_conn;

    server 127.0.0.1:4000 fail_timeout=0;
    # Uncomment these lines for load-balancing multiple instances of streaming for scaling,
    # this assumes your running the streaming server on ports 4000, 4001, and 4002:
    # server 127.0.0.1:4001 fail_timeout=0;
    # server 127.0.0.1:4002 fail_timeout=0;
}

proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=CACHE:10m inactive=7d max_size=1g;

server {
  listen 80;
  listen [::]:80;
  server_name example.com; // [!code --]
  server_name mastodon.kkhys.me; // [!code ++]
  root /home/mastodon/live/public;
  location /.well-known/acme-challenge/ { allow all; }
  location / { return 301 https://$host$request_uri; }
}

server {
  listen 443 ssl http2; // [!code --]
  listen 443 ssl; // [!code ++]
  listen [::]:443 ssl http2; // [!code --]
  listen [::]:443 ssl; // [!code ++]
  http2 on; // [!code ++]

  server_name example.com; // [!code --]
  server_name mastodon.kkhys.me; // [!code ++]

  ssl_protocols TLSv1.2 TLSv1.3;

  # You can use https://ssl-config.mozilla.org/ to generate your cipher set.
  # We recommend their "Intermediate" level.
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;

  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_tickets off;

  # Uncomment these lines once you acquire a certificate:
  # ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem; // [!code --]
  ssl_certificate /etc/letsencrypt/live/mastodon.kkhys.me/fullchain.pem; // [!code ++]
  # ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; // [!code --]
  ssl_certificate_key /etc/letsencrypt/live/mastodon.kkhys.me/privkey.pem; // [!code ++]

  keepalive_timeout    70;
  sendfile             on;
  client_max_body_size 99m;

  root /home/mastodon/live/public;

  gzip on;
  gzip_disable "msie6";
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml image/x-icon;

  location / {
    try_files $uri @proxy;
  }

  # If Docker is used for deployment and Rails serves static files,
  # then needed must replace line `try_files $uri =404;` with `try_files $uri @proxy;`.
  location = /sw.js {
    add_header Cache-Control "public, max-age=604800, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/assets/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/avatars/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/emoji/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/headers/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/packs/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/shortcuts/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/sounds/ {
    add_header Cache-Control "public, max-age=2419200, must-revalidate";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    try_files $uri =404;
  }

  location ~ ^/system/ {
    add_header Cache-Control "public, max-age=2419200, immutable";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";
    add_header X-Content-Type-Options nosniff;
    add_header Content-Security-Policy "default-src 'none'; form-action 'none'";
    try_files $uri =404;
  }

  location ^~ /api/v1/streaming {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Proxy "";

    proxy_pass http://streaming;
    proxy_buffering off;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains";

    tcp_nodelay on;
  }

  location @proxy {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Proxy "";
    proxy_pass_header Server;

    proxy_pass http://backend;
    proxy_buffering on;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_cache CACHE;
    proxy_cache_valid 200 7d;
    proxy_cache_valid 410 24h;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    add_header X-Cached $upstream_cache_status;

    tcp_nodelay on;
  }

  error_page 404 500 501 502 503 504 /500.html;
}
```

Nginx ã®è¨­å®šã¯å®Œäº†ã—ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦èµ·å‹•ã•ã›ã‚‹ã€‚

```shell
chmod 701 /home/mastodon

# Nginx ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹
nginx -t

killall nginx

systemctl enable --now nginx
```

æœ€å¾Œã« Mastodon ã‚µãƒ¼ãƒ“ã‚¹ã‚’ Systemd ã«è¨­å®šã—ã¦èµ·å‹•ã™ã‚‹ã€‚

```shell
# Mastodon ã® Systemd ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
# ã“ã‚Œã«ã‚ˆã‚Šã€Mastodon ãŒã‚·ã‚¹ãƒ†ãƒ ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ç®¡ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹
cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/

# Systemd ã«æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èªè­˜ã•ã›ã‚‹
systemctl daemon-reload

# Mastodon é–¢é€£ã® 3 ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«é–‹å§‹ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã€å³åº§ã«ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹
systemctl enable --now mastodon-{web,sidekiq,streaming}
```

ã“ã‚Œã§ Mastodon ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ§‹ç¯‰ã¯å®Œäº†ã€‚
URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨æ­£å¸¸ã«ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã€‚

å¿™ã—ã„äººã¯ã“ã“ã¾ã§ã§ã‚‚ååˆ† Mastodon ãƒ©ã‚¤ãƒ•ã‚’æ¥½ã—ã‚ã‚‹ã®ã§é›¢è„±ã—ã¦ã‚‚å•é¡Œãªã„ã€‚
ãŸã ã—ã€ã‚ˆã‚Šè‰¯ã„æ©Ÿèƒ½ã‚’ãƒ¦ãƒ¼ã‚¶ã«æä¾›ã—ãŸã„äººã‚„ä»Šå¾Œç™ºç”Ÿã™ã‚‹ã§ã‚ã‚ã†å•é¡Œã‚’ã‚ã‚‰ã‹ã˜ã‚ç‰‡ä»˜ã‘ã¦ãŠããŸã„äººã¯ä»¥ä¸‹ã®ä½œæ¥­ã‚‚ä½µã›ã¦è¡Œã£ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚

## ãã®ã»ã‹ã«ã‚„ã£ã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„ã“ã¨

### ImageMagick ã‹ã‚‰ libvips ã«åˆ‡ã‚Šæ›¿ãˆã‚‹

[v4.3.0](https://github.com/mastodon/mastodon/releases/tag/v4.3.0) ã§ ImageMagick ã‚µãƒãƒ¼ãƒˆãŒå»ƒæ­¢ã•ã‚Œã€libvips ãŒæ¡ç”¨ã•ã‚ŒãŸã®ã§ãã®å¯¾å¿œã‚’è¡Œã†ã€‚

æœ¬æ¥ãªã‚‰ä¸Šè¿°ã—ãŸèª¬æ˜ã«çµ„ã¿è¾¼ã‚€ã¹ãã§ã‚ã‚‹ãŒã€ã‚ãã¾ã§è¨˜äº‹ã«ã¯å±¥æ­´ã¨ã—ã¦æ®‹ã—ã¦ãŠããŸã„ã®ã§ã“ã®ã‚ˆã†ãªå½¢å¼ã‚’ã¨ã£ã¦ã„ã‚‹ï¼ˆè¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹é€”ä¸­ã§ v4.3.0 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸï¼‰ã€‚

ã¾ãšã¯ pacman ã§ libvips ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
sudo pacman -S libvips
```

libvips ã®ææ¡ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã¤ã„ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãï¼ˆå¾Œã€… warning ãŒå‡ºã‚‹ã®ã§ï¼‰ã€‚

```shell
sudo pacman -S libheif imagemagick openslide poppler-glib
```

æ¬¡ã« `.env.production` ã‚’ç·¨é›†ã—ã¦ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹ã€‚

```text title=".env/production"
MASTODON_USE_LIBVIPS=true // [!code ++]
```

æœ€å¾Œã« Mastodon ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã™ã‚Œã°å®Œäº†ã€‚

```shell
sudo systemctl restart mastodon-{web,sidekiq,streaming}
```

### å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã®è¿½åŠ 

Mastodon ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒæŠ•ç¨¿ã‚’åŠ¹ç‡çš„ã«æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã‚‹ã€‚
ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒˆã‚¥ãƒ¼ãƒˆã‚„ãƒ¦ãƒ¼ã‚¶ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãªã©ã‚’å®¹æ˜“ã«æ¤œç´¢ã§ãã€ã‚ˆã‚Šå¿«é©ãªåˆ©ç”¨ä½“é¨“ã®æä¾›ãŒå¯èƒ½ã¨ãªã‚‹ã€‚

ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦ã€å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã†ã€‚

```shell
# admin ãƒ¦ãƒ¼ã‚¶ã§å®Ÿè¡Œã™ã‚‹
pacman -S jdk17-openjdk

# ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ mastodon ãƒ¦ãƒ¼ã‚¶ã«æˆ»ã‚‹
exit

paru -S elasticsearch7
```

Mastodon ã§ã¯å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã« [Elasticsearch](https://www.elastic.co/jp/elasticsearch) ã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã«å¾“ã†ã€‚
Mastodon ã¯ Elasticsearch ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 7 ã§ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ 7 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ï¼ˆæœ€æ–°ç‰ˆã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 8ï¼‰ã€‚

Elasticsearch ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹ã€‚

```shell
vim /home/mastodon/live/.env.production
```

```text title="/home/mastodon/live/.env.production"
ES_ENABLED=true // [!code ++]
ES_HOST=localhost // [!code ++]
ES_PORT=9200 // [!code ++]
ES_PRESET=single_node_cluster // [!code ++]
```

æ¬¡ã« Elasticsearch ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒãƒ¼ãƒ‰æ§‹æˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã€‚

```shell
vim /etc/elasticsearch/elasticsearch.yml
```

```yaml title="/etc/elasticsearch/elasticsearch.yml"
# Elasticsearch ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ï¼ˆèªè¨¼ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
xpack.security.enabled: true // [!code ++]

# Elasticsearch ã‚’å˜ä¸€ãƒãƒ¼ãƒ‰æ§‹æˆã§å‹•ä½œã•ã›ã‚‹
discovery.type: single-node // [!code ++]
```

ç¶šã„ã¦ã€Elasticsearch ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã¨ãƒ¦ãƒ¼ã‚¶ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®šã‚’è¡Œã†ã€‚

**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ãªã„ Elasticsearch ã«å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€èªè¨¼ãªã—ã§ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›´æ¥é€ä¿¡ã™ã‚‹ã ã‘ã§ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã‚ã‚‹ã€‚**
ã“ã®å ´åˆã€Elasticsearch ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å®Œå…¨ã«ç„¡é˜²å‚™ãªçŠ¶æ…‹ã¨ãªã‚Šã€èª°ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’é–²è¦§ãƒ»æ“ä½œã§ãã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å¤§ããªãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚

ãŸã ã€iptables ã§ãƒãƒ¼ãƒˆã‚’åˆ¶é™ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒˆ 9200 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ã—ã¦ã‚‚å¼¾ã‹ã‚Œã‚‹ã€‚
ãã®ãŸã‚ã€å¿…ãšã—ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ãªã„ã¨ã„ã‘ãªã„ã‚ã‘ã§ã¯ãªã„ãŒã€ä¸‡ãŒä¸€ã®ãŸã‚ã«è¨­å®šã—ã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„ã€‚

```shell
# Elasticsearch ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã€ã‚µãƒ¼ãƒå†èµ·å‹•å¾Œã‚‚è‡ªå‹•ã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
systemctl enable --now elasticsearch

# Elasticsearchç”¨ã®ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’ä½œæˆã™ã‚‹
/usr/share/elasticsearch/bin/elasticsearch-keystore create

# Elasticsearch ã®å†…è”µãƒ¦ãƒ¼ã‚¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ï¼‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto

Changed password for user apm_system
PASSWORD apm_system = xxx

Changed password for user kibana_system
PASSWORD kibana_system = xxx

Changed password for user kibana
PASSWORD kibana = xxx

Changed password for user logstash_system
PASSWORD logstash_system = xxx

Changed password for user beats_system
PASSWORD beats_system = xxx

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = xxx

Changed password for user elastic
PASSWORD elastic = xxx
```

æ¬¡ã« Mastodon å°‚ç”¨ã®ãƒ¦ãƒ¼ã‚¶ã¨ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

```shell
# mastodon_full_access ã¨ã„ã†åå‰ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹
curl -X POST -u elastic:xxx "localhost:9200/_security/role/mastodon_full_access?pretty" -H 'Content-Type: application/json' -d'
{
  // Elasticsearch ã‚¯ãƒ©ã‚¹ã‚¿ã®ç›£è¦–æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹
  "cluster": ["monitor"],
  "indices": [{
    "names": ["*"],
    "privileges": ["read", "monitor", "write", "manage"]
  }]
}
'

# mastodon ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹
curl -X POST -u elastic:xxx "localhost:9200/_security/user/mastodon?pretty" -H 'Content-Type: application/json' -d'
{
  "password" : "xxx",
  // å…ˆã»ã©ä½œæˆã—ãŸ mastodon_full_access ãƒ­ãƒ¼ãƒ«ã‚’ã“ã®ãƒ¦ãƒ¼ã‚¶ã«å‰²ã‚Šå½“ã¦ã‚‹
  "roles" : ["mastodon_full_access"]
}
'
```

ãªãŠã€curl ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« `-u` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Basic èªè¨¼ã‚’ä½¿ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œãˆã‚‹ã€‚

Elasticsearch ã« mastodon ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ãŸã®ã§ã€Mastodon ã‚¢ãƒ—ãƒªã®ç’°å¢ƒå¤‰æ•°ã«ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã€‚

```shell
vim /home/mastodon/live/.env.production
```

```text title="/home/mastodon/live/.env.production"
ES_USER=mastodon // [!code ++]
ES_PASS=xxx // [!code ++]
```

Elasticsearch ã®è¨­å®šã¯å®Œäº†ã—ãŸãŸã‚ã€æ¬¡ã« Mastodon é–¢é€£ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã•ã›ã¦ã‹ã‚‰å…¨æ–‡æ¤œç´¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚

```shell
systemctl restart mastodon-sidekiq

systemctl reload mastodon-web

su - mastodon

cd live

RAILS_ENV=production bin/tootctl search deploy
```

`tootctl search deploy` ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ãŸå¾Œã¯ã€Mastodon ãŒè‡ªå‹•çš„ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¦ãã‚Œã‚‹ã®ã§æ‰‹å‹•ã§æ›´æ–°ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚

ã“ã“ã¾ã§ã®ä½œæ¥­ã§å•é¡Œãªãæ¤œç´¢ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã¯ãšã€‚
ã ãŒã€ã“ã®ã¾ã¾ã§ã¯è² è·ãŒå¤§ãã„æ¤œç´¢å‡¦ç†ã‚’è¡Œã†ã¨ã€2GB ã®å°ã•ã„ãƒ¡ãƒ¢ãƒªã§ã¯ Elasticsearch ãŒç¨€ã«è½ã¡ã¦ã—ã¾ã†ã€‚

ãã‚Œã‚’é˜²ããŸã‚ã«åˆæœŸãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã¨æœ€å¤§ãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã—ã¦ãŠãã€‚

é©åˆ‡ãªãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ãŸã€‚

https://github.com/felx/mastodon-documentation/blob/master/Running-Mastodon/Elasticsearch-guide.md

2GB ã®å ´åˆã¯ 512MB ãŒé©åˆ‡ãªã‚µã‚¤ã‚ºã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚

```shell
vim /etc/elasticsearch/jvm.options.d/ram.options
```

```text title="/etc/elasticsearch/jvm.options.d/ram.options"
-Xms512m
-Xmx512m
```

Elasticsearch ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¦ã€é©åˆ‡ã«ãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```shell
systemctl restart elasticsearch

curl -X GET -u elastic:xxx "localhost:9200/_nodes?pretty"
```

```json
{
  // ...
  "jvm" : {
    "mem" : {
      "heap_init_in_bytes" : 536870912,
      "heap_max_in_bytes" : 536870912
    }
  }
  // ...
}
```

ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°å•é¡Œãªã—ã€‚

æ¬¡ã«ã€æ—¥æœ¬èªæ¤œç´¢ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã« Elasticsearch ã®æ—¥æœ¬èªå½¢æ…‹ç´ è§£æç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ [Kuromoji](https://www.elastic.co/guide/en/elasticsearch/plugins/current/analysis-kuromoji.html) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
å¾Œè¿°ã™ã‚‹ç†ç”±ã«ã‚ˆã‚Šçµå±€ Kuromoji ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯æ­¢ã‚ã‚‹ã‘ã©ã€ãƒ¡ãƒ¢ã¨ã—ã¦ä½œæ¥­å†…å®¹ã¯æ®‹ã—ã¦ãŠãã€‚

Kuromoji ã®ä»£ã‚ã‚Šã«ã€å¾Œç™ºã® [Sudachi](https://github.com/WorksApplications/elasticsearch-sudachi) ã‚’ä½¿ç”¨ã™ã‚‹é¸æŠè‚¢ã‚‚ã‚ã‚‹ã€‚
ãŸã ã—ã€æ¤œç´¢å¯¾è±¡ã«ç‰¹æ®Šãªæ¥­å‹™ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒãªã„å ´åˆã¯ã€ã©ã¡ã‚‰ã‚’é¸ã‚“ã§ã‚‚å¤§å·®ã¯ãªã„[^2]ã€‚
å°å…¥ãŒç°¡å˜ãª Kuromoji ã®æ–¹ãŒãŠã™ã™ã‚ã€‚

[^2]: [æ¤œç´¢åŸºç›¤ãƒãƒ¼ãƒ ã®ElasticsearchÃ—Sudachiç§»è¡Œæˆ¦ç•¥ã¨å®Ÿè·µ](https://www.m3tech.blog/entry/sudachi-es)ã€‚ã“ã®è¨˜äº‹ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ‰±ã†ã®ã§ã‚ã‚Œã° Sudachi ã®æ–¹ãŒå‘ã„ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„

Kuromoji ã‚’ä½¿ã†ã¨ã©ã®ã‚ˆã†ãªåˆ©ç‚¹ãŒã‚ã‚‹ã‹ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚‹ã€‚

https://techblog.zozo.com/entry/elasticsearch-mapping-config-for-japanese-search

ã¾ãšã¯ Elasticsearch ã«ä»˜å±ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ Kuromoji ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
sudo /usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-kuromoji
```

Elasticsearch ã‚’å†èµ·å‹•ã—ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã¡ã‚ƒã‚“ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‹ç¢ºèªã™ã‚‹ã€‚

```shell
sudo systemctl restart elasticsearch
```

```shell
curl -X GET -u elastic:xxx "localhost:9200/_cat/plugins?v"

name  component         version
vultr analysis-kuromoji 7.17.18
```

å•é¡Œãªãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã€‚

ã“ã®çŠ¶æ…‹ã§ Elasticsearch ã‚’å†èµ·å‹•ã—ã¦ã€æ¤œç´¢ã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¦ã¿ãŸãŒæ€ã£ãŸçµæœãŒè¿”ã£ã¦ã“ãªã„ã€‚
èª¿ã¹ã‚‹ã¨ã€Ruby ã§ã¯ Elasticsearch ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã« [chewy](https://github.com/toptal/chewy) ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€Kuromoji ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã«ã¯ chewy ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

Mastodon ã§ã¯ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã€‚

```shell
curl -X GET -u elastic:xxx "localhost:9200/_cat/indices?v"

health status index                uuid  pri rep docs.count docs.deleted store.size pri.store.size
green  open   .geoip_databases     xxx   1   0         38            0     36.7mb         36.7mb
green  open   .security-7          xxx   1   0          9            0     35.1kb         35.1kb
green  open   chewy_specifications xxx   1   0          5            0     19.3kb         19.3kb
green  open   instances            xxx   1   0         12            0      5.4kb          5.4kb
green  open   statuses             xxx   5   0        298            0    297.4kb        297.4kb
green  open   accounts             xxx   1   0         22            0     18.4kb         18.4kb
green  open   public_statuses      xxx   5   0        295            0    287.1kb        287.1kb
green  open   tags                 xxx   1   0         22            0      7.2kb          7.2kb
```

Mastodon ã¯ä¸»ã«ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

- statuses: æŠ•ç¨¿ã®æ¤œç´¢ã«ä½¿ç”¨
- accounts: ãƒ¦ãƒ¼ã‚¶ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¤œç´¢ã«ä½¿ç”¨
- public_statuses: å…¬é–‹ãƒˆã‚¥ãƒ¼ãƒˆã®æ¤œç´¢ã«ä½¿ç”¨
- tags: ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®æ¤œç´¢ã«ä½¿ç”¨
- instances: ä»–ã® Mastodon ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±ã®æ¤œç´¢ã‚„ç®¡ç†ã«ä½¿ç”¨

chewy ã« Kuromoji ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å®šç¾©ã™ã‚Œã° Kuromoji ã¯ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã‘ã©ã€ä»Šå›ã® Mastodon ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å»ºè¨­ã®å‰æã¨ã—ã¦ã€æŒç¶šçš„ã«æ¥½ã‚’ã—ã¦é‹å–¶ã—ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒèµ·ã“ã‚Šãã†ãªå¤‰æ›´ã¯ãªã‚‹ã¹ãã—ãŸããªã„ã€‚
ãã®çµæœã€è¿·ã£ãŸã‘ã© Kuromoji ã®å°å…¥ã¯è¦‹é€ã£ãŸã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ Kuromoji ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```shell
sudo /usr/share/elasticsearch/bin/elasticsearch-plugin remove analysis-kuromoji
```

ã‚ã¨ã€å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰æ°—ã¥ã„ãŸã‘ã©ã€ã¾ã•ã‹ã®**ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ã¨æ¤œç´¢æ©Ÿèƒ½ãŒä½¿ãˆãªã„**ã¨ã„ã†ã€‚ã€‚
ãŠã²ã¨ã‚Šæ§˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚Œã°ã€è‡ªåˆ†ã—ã‹æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ãˆãªã„ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã‹ã‚‰ã€ãªã‚“ã ã‹ãªã¨ã„ã†æ®‹å¿µãªæ°—åˆ†ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã›ãšã«æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ãˆã‚‹æ–¹æ³•ã‚‚å¿…ãšã‚ã‚‹ã¨ã¯ã‚ã‹ã£ã¦ã„ã‚‹ã‘ã©ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã§ãã‚‹ã ã‘å¼„ã‚ŠãŸããªã„ã‹ã‚‰ã©ã†ã™ã‚‹ã‹è€ƒãˆã¦ã„ã‚‹ã€‚

Mastodon ã¯æ¤œç´¢æ©Ÿèƒ½ã‚’é‡è¦–ã›ãšã«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°åé‡ã®æ€æƒ³ã¨ã„ã†ã®ã¯ãªã‚“ã¨ãªãã‚ã‹ã£ãŸã€‚
é€†ã«ã„ãˆã°ã€æ˜”ã®æŠ•ç¨¿ã‚’æ˜ã‚Šè¿”ã•ã‚ŒãŸã‚Šã—ãªã„ã‹ã‚‰è‰¯ã„ã®ã‹ï¼Ÿ

### ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ­ã‚°ã®å®¹é‡ã‚’åˆ¶é™ã—ãªã„ã¨ç„¡é™ã«å¢—ãˆç¶šã‘ã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’åœ§è¿«ã—ã¦ã—ã¾ã†ãŸã‚å¯¾ç­–ã‚’ã—ã¦ãŠãã€‚

ä»¥ä¸‹ãŒãƒ­ã‚°ã‚’ 1 ãƒ¶æœˆæ”¾ç½®ã—ç¶šã‘ãŸçµæœã§ã‚ã‚‹ã€‚

```shell
du -h -d1 /var/log

30M     /var/log/nginx
44K     /var/log/letsencrypt
4.0K    /var/log/old
1.5M    /var/log/elasticsearch
4.0K    /var/log/gssproxy
4.0K    /var/log/private
4.0K    /var/log/audit
1.2G    /var/log/journal
1.2G    /var/log
```

ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºãŒ 1.2GB ã¨ã‹ãªã‚Šå¤§ãããªã£ã¦ã„ã‚‹ã€‚

ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ­ã‚°ç®¡ç†ã¨ã‚µã‚¤ã‚ºåˆ¶å¾¡ã®ãŸã‚ã«ã€logrotate ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ãƒ­ã‚°ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹ã€‚

```shell
pacman -S logrotate

vim /etc/logrotate.conf
```

`/etc/logrotate.conf` ã«ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚

```text title="/etc/logrotate.conf" showLineNumbers
# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¯æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
daily

# æŒ‡å®šã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ãšã«å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹
missingok

# ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ä¿å­˜ã•ã‚Œã‚‹å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã‚’æŒ‡å®šã™ã‚‹
rotate 4

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒ 20MB ä»¥ä¸Šã®å ´åˆã«ã®ã¿ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
size 20M

# ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«æ–°ã—ã„ï¼ˆç©ºã®ï¼‰ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
create

# ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã™ã‚‹
compress

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã™ã‚‹ã®ã‚’æ¬¡å›ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§é…å»¶ã•ã›ã‚‹
delaycompress

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã®å ´åˆã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãªã„
notifempty

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ç„¡è¦–ã•ã‚Œã‚‹æ‹¡å¼µå­ã®ãƒªã‚¹ãƒˆ
tabooext + .pacorig .pacnew .pacsave

# è¿½åŠ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ä½¿ç”¨ã™ã‚‹
include /etc/logrotate.d
```

`/etc/logrotate.d` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®å€‹åˆ¥è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚
ã“ã“ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚ŠãŒã¡ãª nginx ã®ã¿è¨­å®šã™ã‚‹ã“ã¨ã¨ã™ã‚‹ã€‚

```text title="/etc/logrotate.d/nginx" showLineNumbers
/var/log/nginx/*log {
        missingok
        notifempty
        create 640 http root
        sharedscripts
        compress
        postrotate
                test ! -r /run/nginx.pid || kill -USR1 `cat /run/nginx.pid`
        endscript
}
```

`logrotate` ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰‹å‹•ã§å¼·åˆ¶å®Ÿè¡Œã—ã€`/etc/logrotate.conf` ã®è¨­å®šã«å¾“ã£ã¦å³åº§ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚
ã“ã“ã§æŒ‡å®šã—ãŸã¨ãŠã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ããªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãŠãã“ã¨ã€‚

```shell
logrotate -f /etc/logrotate.conf
```

journald ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€logrotate ã§ç®¡ç†ã™ã‚‹ã®ã§ã¯ãªãã€journald è‡ªä½“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`/etc/systemd/journald.conf`ï¼‰ã§è¨­å®šã—ã¦ã„ãã€‚

```shell
vim /etc/systemd/journald.conf
```

```text title="/etc/systemd/journald.conf"
[Journal]
# ãƒ­ã‚°ã‚’æ°¸ç¶šçš„ã«ä¿å­˜ã™ã‚‹
Storage=persistent

# æœ€å¤§ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ 200MB ã«åˆ¶é™ã™ã‚‹
SystemMaxUse=200M

# ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã®æœ€å¤§ä¿æŒæœŸé–“ã‚’ 2 é€±é–“ã«è¨­å®šã™ã‚‹
MaxRetentionSec=2weeks
```

ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚’åé›†ãƒ»ç®¡ç†ã™ã‚‹ systemd-journald ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’å†èµ·å‹•ã—ã¦ã€è¨­å®šå¤‰æ›´ã‚’åæ˜ ã•ã›ã‚‹ã€‚

```shell
systemctl restart systemd-journald
```

æœ€å¾Œã«ãƒ­ã‚°ã‚µã‚¤ã‚ºã‚’ç¢ºèªã€‚

```shell
du -h -d1 /var/log

4.2M    /var/log/nginx
44K     /var/log/letsencrypt
4.0K    /var/log/old
996K    /var/log/elasticsearch
4.0K    /var/log/gssproxy
4.0K    /var/log/private
4.0K    /var/log/audit
121M    /var/log/journal
152M    /var/log
```

ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºãŒ 152MB ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ããŸã€‚

### SSL è¨¼æ˜æ›¸ã®è‡ªå‹•æ›´æ–°

SSL è¨¼æ˜æ›¸ã«ã¯æœŸé™ãŒã‚ã‚‹ãŸã‚ã€å®šæœŸçš„ã«æ›´æ–°ãŒå¿…è¦ã§ã‚ã‚‹ã€‚
æ¯å›æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã®ã¯é¢å€’ãã•ã„ã—ã€å¿…ãšå¿˜ã‚Œã¦ã—ã¾ã†ã®ã§è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ãã€‚

ã¾ãšã¯ SSL è¨¼æ˜æ›¸ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å‹•ä½œã‚’å®šç¾©ã—ã¦ã„ãã€‚

```shell
systemctl edit --full --force certbot-renewal
```

```text
[Unit]
Description=Certbot Renewal Service

[Service]
# ã‚µãƒ¼ãƒ“ã‚¹ã¯ä¸€åº¦å®Ÿè¡Œã•ã‚Œã‚‹ã¨å®Œäº†ã™ã‚‹
Type=oneshot

# è¨¼æ˜æ›¸ã®æ›´æ–°ã‚’è¡Œã† Certbot ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
ExecStart=/usr/bin/certbot renew

# ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†é›¢ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹
PrivateTmp=true
```

æ¬¡ã« certbot-renewal.timer ã¨ã„ã†ã‚¿ã‚¤ãƒãƒ¼ã‚’å®šç¾©ã™ã‚‹ã€‚

```shell
sudoedit /etc/systemd/system/certbot-renewal.timer
```

```text
[Unit]
Description=Run Certbot Renewal Twice Daily

[Timer]
# æ¯æ—¥åˆå‰ 0 æ™‚ã¨åˆå¾Œ 12 æ™‚ã« Certbot æ›´æ–°ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹
OnCalendar=*-*-* 00,12:00:00

# ã‚¿ã‚¤ãƒãƒ¼ãŒã‚·ã‚¹ãƒ†ãƒ ãŒåœæ­¢ä¸­ã®é–“ã«å®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸå ´åˆã€æ¬¡å›èµ·å‹•æ™‚ã«ç›´ã¡ã«å®Ÿè¡Œã™ã‚‹
Persistent=true

[Install]
# timers.target ã«ã‚ˆã£ã¦ã‚¿ã‚¤ãƒãƒ¼ãŒèµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
WantedBy=timers.target
```

æœ€å¾Œã« `certbot-renewal.timer` ã‚’è‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚

```shell
systemctl daemon-reload

systemctl enable --now certbot-renewal.timer
```

æ­£ã—ãç™»éŒ²ã•ã‚ŒãŸã‹ç¢ºèªã™ã‚‹ã€‚

```shell
systemctl list-timers

NEXT                          LEFT LAST                               PASSED UNIT                             ACTIVATES
Sun 2024-10-27 00:00:00 JST  51min Sat 2024-10-26 12:00:00 JST       11h ago certbot-renewal.timer            certbot-renewal.service
```

å•é¡Œãªã—ã€‚

å¿µã®ç‚ºã€å®šæœŸçš„ã« SSL è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèªã—ã¦ãŠãã¨å®‰å¿ƒã€‚

```shell
certbot certificates

Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Found the following certs:
  Certificate Name: mastodon.kkhys.me
    Serial Number: xxx
    Key Type: xxx
    Domains: mastodon.kkhys.me
    Expiry Date: 2025-01-17 14:27:26+00:00 (VALID: 83 days)
    Certificate Path: /etc/letsencrypt/live/mastodon.kkhys.me/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/mastodon.kkhys.me/privkey.pem
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
```

### ä»–ã«ã‚„ã‚Šæ®‹ã—ãŸã“ã¨

æ™‚é–“ã¨é‡‘éŠ­çš„ãªä½™è£•ãŒã‚ã‚Œã°ä»¥ä¸‹ã®ä½œæ¥­ã‚’ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã€‚

- Tor ã‚’é€šã˜ã¦ã‚ªãƒ‹ã‚ªãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æä¾›ã™ã‚‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ Neon ãªã©ã® Saas ã«åˆ†é›¢ã•ã›ã‚‹

## ã•ã„ã”ã«

Mastodon ã¯æ€ã£ã¦ã„ãŸã‚ˆã‚Šã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ã„ã‚‹ã—ã€æ©Ÿèƒ½ã‚‚è±Šå¯Œã§ã€å–„æ„ã§æˆã‚Šç«‹ã£ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¨ã¯æ€ãˆãªã„å®Œæˆåº¦ã ã€‚
è‰¯ã„æ„å‘³ã§æ¯ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã€çªç„¶ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œãªããªã£ãŸã‚Šã™ã‚‹å±é™ºæ€§ãŒãªã„ã®ã¯å®‰å¿ƒã§ãã‚‹ã€‚

å‘¨ã‚Šã®çŸ¥ã‚Šåˆã„ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚‹äººãŒå°‘ãªã„ã®ãŒé›£ç‚¹ã€ã¨ã„ã†ã‚ˆã‚Šã‚‚ä¸€ç•ªã®å•é¡Œã ã‘ã©ã€é€†ã«èª°ã«ã‚‚è¦‹ã‚‰ã‚Œã¦ã„ãªã„ã‹ã‚‰æ°—æ¥½ã«ã¤ã¶ã‚„ã‘ã¦å¿ƒåœ°ã‚ˆã„ã€‚
ä»Šå¾Œã€Mastodon ã®è¡Œæ–¹ã¯ã‚†ã‚‹ãè¦³æ¸¬ã—ã¦ã„ãã€‚
