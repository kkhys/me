---
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"video"> {}

const { src, title, autoplay } = Astro.props;

const hasAutoplay = autoplay !== undefined && autoplay !== false;
---

<video-player>
  {title ? (
    <figure>
      <div class="video-wrapper">
        <video
          controls={!hasAutoplay}
          playsinline
          muted
          preload="metadata"
          autoplay={hasAutoplay}
          style="width:100%"
        >
          <source src={src} type="video/mp4" />
          お使いのブラウザはビデオをサポートしていません。
        </video>
        {!hasAutoplay && (
          <button type="button" class="play-button" aria-label="ビデオを再生" hidden>
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          </button>
        )}
      </div>
      <figcaption class="video-caption">{title}</figcaption>
    </figure>
  ) : (
    <div class="video-wrapper">
      <video
        controls={!hasAutoplay}
        playsinline
        muted
        preload="metadata"
        autoplay={hasAutoplay}
        style="width:100%"
      >
        <source src={src} type="video/mp4" />
        お使いのブラウザはビデオをサポートしていません。
      </video>
      {!hasAutoplay && (
        <button type="button" class="play-button" aria-label="ビデオを再生" hidden>
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
      )}
    </div>
  )}
</video-player>

<style>
  video-player {
    display: block;
    margin-block: 2.5rem;
  }

  .video-wrapper {
    position: relative;
    user-select: none;
    border-radius: 1rem;
    overflow: hidden;
  }

  .video-caption {
    text-align: center;
    font-size: var(--fs-xs);
    color: var(--c-sub);
    margin-top: 0.5rem;
    line-height: 1.5;
  }
</style>

<script>
  class VideoPlayer extends HTMLElement {
    private video: HTMLVideoElement | null = null;
    private playButton: HTMLButtonElement | null = null;

    connectedCallback() {
      this.video = this.querySelector('video');
      this.playButton = this.querySelector('.play-button');

      if (this.video && this.playButton) {
        // Remove native controls; custom play button takes over
        this.video.controls = false;
        this.playButton.hidden = false;
        this.playButton.addEventListener('click', this.handlePlayClick);
      }
    }

    private handlePlayClick = (e: Event) => {
      e.preventDefault();

      if (this.playButton && this.video) {
        this.playButton.style.opacity = '0';
        this.playButton.style.pointerEvents = 'none';

        setTimeout(() => {
          if (this.playButton && this.video) {
            this.playButton.style.display = 'none';
            this.video.controls = true;
            this.video.play();
            this.video.focus();
          }
        }, 300);
      }
    };
  }

  customElements.define('video-player', VideoPlayer);
</script>
