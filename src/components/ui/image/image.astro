---
import { Picture as AstroPicture, getImage, type Picture } from "astro:assets";
import type { UnresolvedImageTransform } from "astro";

import type { CustomImageProps } from "./types";

type Props = CustomImageProps;

const { class: className, title, ...rest } = Astro.props;

const blurryImage = await getImage({
  ...(rest as UnresolvedImageTransform),
  width: 20,
});

const pictureProps = {
  class: `image-rounded ${className ?? ""}`.trim(),
  formats: ["avif"],
  quality: 80,
  widths: [640, 750, 828, 1080, 1344],
  sizes: `(min-width: 672px) 672px, 100vw`,
  onload: "this.closest('.blur-load')?.classList.add('image-loaded')",
  ...rest,
} as Parameters<typeof Picture>[0];
---

{title ? (
  <figure>
    <div class:list={["blur-load-wrapper", "image-rounded", "image-border", className]}>
      <div class="blur-load">
        <AstroPicture {...pictureProps} />
      </div>
    </div>
    <figcaption class="image-caption">{title}</figcaption>
  </figure>
) : (
  <div class:list={["blur-load-wrapper", "image-rounded", "image-border", className]}>
    <div class="blur-load">
      <AstroPicture {...pictureProps} />
    </div>
  </div>
)}

<style define:vars={{ 'bg-image': `url(${blurryImage.src})` }}>
  .image-rounded {
    border-radius: var(--radius-lg);
    user-select: none;
  }

  .image-border {
    border: 1px solid light-dark(transparent, var(--c-border));
  }

  .image-caption {
    text-align: center;
    font-size: var(--fs-xs);
    color: var(--c-sub);
    margin-top: 0.5rem;
    line-height: 1.5;
  }

  .blur-load-wrapper {
    overflow: hidden;
  }

  .blur-load {
    background: var(--bg-image) center / cover no-repeat;
    filter: blur(36px);
    transition: filter 250ms ease-in-out;

    &.image-loaded {
      background: none;
      filter: blur(0);
    }
  }
</style>
