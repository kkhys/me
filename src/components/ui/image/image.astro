---
import { Picture as AstroPicture, getImage, type Picture } from "astro:assets";
import type { UnresolvedImageTransform } from "astro";

import { cn } from "#/lib/ui";
import type { CustomImageProps } from "./types";

type Props = CustomImageProps;

const { class: className, ambientMode, title, ...rest } = Astro.props;

const blurryImage = await getImage({
  ...(rest as UnresolvedImageTransform),
  width: 20,
});

const divClass = cn(
  "blur-load select-none rounded-2xl border-[var(--uchu-yin-8)] dark:border",
  ambientMode && "ambient-mode",
  className,
);

const pictureProps = {
  class: cn("rounded-2xl", className),
  formats: ["avif"],
  quality: 80,
  widths: [640, 750, 828, 1080, 1344],
  sizes: `(min-width: 672px) 672px, 100vw`,
  onload: "this.closest('.blur-load')?.classList.add('image-loaded')",
  ...rest,
} as Parameters<typeof Picture>[0];
---

{title ? (
  <figure>
    <div class={divClass}>
      <AstroPicture {...pictureProps} />
    </div>
    <figcaption class="text-center text-xs text-muted-foreground mt-2 leading-6">{title}</figcaption>
  </figure>
) : (
  <div class={divClass}>
    <AstroPicture {...pictureProps} />
  </div>
)}

<style define:vars={{ 'bg-image': `url(${blurryImage.src})` }}>
  .blur-load {
    background: var(--bg-image) center / cover no-repeat;
    filter: blur(36px);
    transition: filter 250ms ease-in-out;

    &.image-loaded {
      background: none;
      filter: blur(0);
    }
  }

  .ambient-mode {
    position: relative;

    &::before {
      content: '';
      position: absolute;
      inset: -1.5%;
      max-width: 100vw;
      background: var(--bg-image) center / cover no-repeat;
      filter: blur(64px);
      opacity: 0.25;
      z-index: -10;
    }
  }
</style>
