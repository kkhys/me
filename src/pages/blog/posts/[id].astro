---
import { render } from "astro:content";
import type { GetStaticPaths } from "astro";
import type { BreadcrumbList, WithContext } from "schema-dts";
import ContentWrapper from "#/features/blog/components/content-wrapper.astro";
import { getCategoryByTitle } from "#/features/blog/config/category";
import { getPublicBlogEntries } from "#/features/blog/utils/entry";
import BlogLayout from "#/layouts/blog-layout.astro";
import { getLastUpdatedTimeByFile } from "#/lib/api/github";
import { getBlogPostingSchema } from "#/lib/json-ld";
import { convertDateToString } from "#/utils/date";
import { extractDescription } from "#/utils/extract-description";

export const getStaticPaths = (async () =>
  (await getPublicBlogEntries()).map((entry) => {
    return {
      params: {
        id: entry.id,
      },
      props: {
        entry,
        description: extractDescription(entry.body ?? ""),
      },
    };
  })) satisfies GetStaticPaths;

const { entry, description } = Astro.props;
const { Content } = await render(entry);
const publishedAtString = convertDateToString(entry.data.publishedAt);

const contentPath = entry.filePath?.replace("content/", "");

if (!contentPath) {
  throw new Error("Content path is not defined");
}

if (import.meta.env.PROD) {
  const { lastUpdatedTime } = await getLastUpdatedTimeByFile(contentPath);

  if (lastUpdatedTime) {
    const updatedAt = new Date(lastUpdatedTime);
    const updatedAtString = convertDateToString(updatedAt);
    entry.data.updatedAt = updatedAt;
    entry.data.updatedAtString = updatedAtString;
  }
}

const blogPostingSchema = getBlogPostingSchema({
  id: entry.id,
  data: entry.data,
  description,
});
const categoryObject = getCategoryByTitle(entry.data.category);

if (!categoryObject) {
  throw new Error(`Category "${entry.data.category}" not found`);
}

const breadcrumbSchema: WithContext<BreadcrumbList> = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Blog",
      item: `${import.meta.env.SITE}/blog`,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: categoryObject.label,
      item: `${import.meta.env.SITE}/blog/categories/${categoryObject.slug}`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: entry.data.title,
      item: `${import.meta.env.SITE}/blog/posts/${entry.id}`,
    },
  ],
};

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [blogPostingSchema, breadcrumbSchema],
};
---

<BlogLayout id={entry.id} publishedAtString={publishedAtString} description={description} {...entry.data}>
  <script
      is:inline
      type='application/ld+json'
      set:html={JSON.stringify(jsonLd)}
      slot='head'
  />
  <ContentWrapper content={Content} />
</BlogLayout>
