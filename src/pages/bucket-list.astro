---
import { getEntry } from "astro:content";
import Budoux from "#/components/budoux.astro";
import CheckIcon from "#/components/icons/check.svg";
import MoveUpRightIcon from "#/components/icons/move-up-right.svg";
import SEO from "#/components/seo/seo.astro";
import Breadcrumb from "#/components/ui/breadcrumb.astro";
import Separator from "#/components/ui/separator.astro";
import BaseLayout from "#/layouts/base-layout.astro";
import { getLastUpdatedTimeByFile } from "#/lib/api/github";
import { BASE_URL } from "#/utils/base-url";
import { convertDateToString } from "#/utils/date";

const bucketList = await getEntry("bucketList", "data");

if (!bucketList) {
  throw new Error("Bucket list not found");
}

let updatedAtString = null;

if (process.env.VERCEL) {
  const filePath = "bucket-list/data.yaml";
  const { lastUpdatedTime } = await getLastUpdatedTimeByFile(filePath);

  if (lastUpdatedTime) {
    const updatedAt = new Date(lastUpdatedTime);
    updatedAtString = convertDateToString(updatedAt);
  }
}

const totalItems = bucketList.data.reduce(
  (total, categoryObj) =>
    total +
    Object.values(categoryObj).reduce(
      (catTotal, items) => catTotal + items.length,
      0,
    ),
  0,
);

const completedItems = bucketList.data.reduce(
  (total, categoryObj) =>
    total +
    Object.values(categoryObj).reduce(
      (catTotal, items) =>
        catTotal + items.filter((item) => item.completedAt).length,
      0,
    ),
  0,
);

const seoDescription =
  "これは僕がこの人生で達成したいこと、手に入れたいことのリストです。";
const seoImage = `${BASE_URL}/api/og/default.png`;
---

<BaseLayout>
  <SEO
    title="バケットリスト"
    description={seoDescription}
    image={seoImage}
    slot='seo'
  />
  <Breadcrumb segments={[{ label: "ホーム", href: "/" }]} />
  <h1 class="page-title">
    バケットリスト
  </h1>
  <Budoux>
    <p class="page-description">これは僕がこの人生で達成したいこと、手に入れたいことのリストです。</p>
  </Budoux>
  <section class="bucket-section">
    <ul class="bucket-list">
      {(() => {
        let globalIndex = 0;
        return bucketList.data.map((categoryObj) =>
          Object.entries(categoryObj).map(([, items]) =>
            items.map(({ title, description, completedAt }) => (
              <li class="bucket-item">
                <div class="bucket-index">
                  <span class="bucket-index-num">
                    {++globalIndex}
                  </span>
                </div>
                <div aria-checked={completedAt ? 'true' : 'false'} class="bucket-check">
                  <span class="bucket-check-inner">
                    {!!completedAt && (
                        <CheckIcon class="bucket-check-icon" />
                    )}
                 </span>
                </div>
                {description ? (
                    <div class="bucket-content">
                      <Budoux><p>{title}</p></Budoux>
                      <Budoux><p class="bucket-desc">{description}</p></Budoux>
                    </div>
                ) : (
                  <Budoux>
                    <p>{title}</p>
                  </Budoux>
                )}
            </li>
          ))
        )
        ).flat(2);
      })()}
    </ul>
  </section>
  <div class="bucket-summary">
    <p class="bucket-summary-text">
      {totalItems}個中{completedItems}個完了しました。
    </p>
  </div>
  <Separator class="bucket-separator" />
  <div class="bucket-footer">
    <p>初回作成日: 2025年6月29日（満30歳）</p>
    {updatedAtString && (
        <p>最終更新日: {updatedAtString}</p>
    )}
    <a href="https://github.com/kkhys/content/commits/main/bucket-list/data.yaml" target="_blank" rel="noreferrer" class="bucket-history-link">
      変更履歴
      <MoveUpRightIcon class="bucket-history-icon" />
    </a>
  </div>
</BaseLayout>

<style>
  .page-description {
    font-size: var(--fs-sm);
    color: var(--c-sub);
    margin-top: 0.5rem;
  }

  .bucket-section {
    margin-top: 2rem;
  }

  .bucket-list {
    list-style: none;
    padding: 0;
    margin-left: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  @media (width >= 640px) {
    .bucket-list {
      margin-left: 0;
    }
  }

  .bucket-item {
    display: flex;
    align-items: flex-start;
    position: relative;
    margin: 0;
  }

  .bucket-index {
    position: absolute;
    left: -1.5rem;
    margin-top: 0.25rem;
    width: 1rem;
    text-align: right;
  }

  .bucket-index-num {
    display: block;
    font-size: var(--fs-2xs);
    color: var(--c-sub);
    font-variant-numeric: tabular-nums;
  }

  .bucket-check {
    margin-right: 0.5rem;
    width: 1rem;
    height: 1rem;
    border-radius: 2px;
    border: 1px solid var(--c-primary);
    box-shadow: var(--shadow-sm);
    opacity: 0.5;
    margin-top: 0.25rem;
    flex-shrink: 0;
  }

  .bucket-check[aria-checked="true"] {
    background-color: var(--c-primary);
    color: var(--c-primary-text);
  }

  .bucket-check-inner {
    display: grid;
    place-content: center;
  }

  .bucket-check-icon {
    width: 1rem;
    height: 1rem;
  }

  .bucket-content {
    display: grid;
    gap: 0.25rem;
  }

  .bucket-desc {
    font-size: var(--fs-xs);
    color: var(--c-sub);
  }

  .bucket-summary {
    margin-top: 1.5rem;
  }

  .bucket-summary-text {
    text-align: right;
    font-size: var(--fs-xs);
    color: var(--c-sub);
  }

  .bucket-separator {
    margin-top: 2rem;
  }

  .bucket-footer {
    margin-top: 2rem;
    font-size: var(--fs-xs);
    color: var(--c-sub);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.375rem;
  }

  .bucket-history-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.125rem;
    text-underline-offset: 4px;
    text-decoration: none;
    color: inherit;
  }

  .bucket-history-link:hover {
    text-decoration: underline;
  }

  .bucket-history-icon {
    width: 0.625rem;
    height: 0.625rem;
  }
</style>
